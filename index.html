<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML / SVG ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</title>
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Preview">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <style>
    /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
    textarea {
      -webkit-overflow-scrolling: touch;
    }
    /* iOS Safariå¯¾å¿œ */
    @supports (-webkit-touch-callout: none) {
      .h-screen {
        height: -webkit-fill-available;
      }
    }
    </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useCallback, useEffect, useMemo } = React;

    // URLçŸ­ç¸®ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆCloudflare Workerï¼‰
    const SHORTENER_URL = 'https://url-shortener.takalovesthailand.workers.dev';
    // åŒæœŸã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    const SYNC_URL = 'https://html-preview-sync.takalovesthailand.workers.dev';

    function HTMLPreviewer() {
      const [code, setCode] = useState('');

      const [isPreviewMaximized, setIsPreviewMaximized] = useState(false);
      const [leftPanelWidth, setLeftPanelWidth] = useState(50);
      const [activeTab, setActiveTab] = useState('library'); // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¿ãƒ–ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ›ãƒ¼ãƒ ï¼‰
      const [isMobile, setIsMobile] = useState(false);
      const [savedItems, setSavedItems] = useState([]);
      const [showLibrary, setShowLibrary] = useState(false);
      const [debouncedCode, setDebouncedCode] = useState('');
      const [isFullscreen, setIsFullscreen] = useState(false);
      const [loadedFile, setLoadedFile] = useState(null); // { name, type: 'PDF'|'HTML'|'SVG'|'IMAGE' }
      const [searchQuery, setSearchQuery] = useState(''); // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œç´¢
      const [showStarredOnly, setShowStarredOnly] = useState(false); // â˜…ã®ã¿è¡¨ç¤º
      const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null }); // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const [showPreviewMenu, setShowPreviewMenu] = useState(false); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ä¸‰ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const [hideUI, setHideUI] = useState(false); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«UIéè¡¨ç¤º
      const lastScrollY = React.useRef(0); // å‰å›ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
      const [selectedItems, setSelectedItems] = useState(new Set()); // é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ID
      const [syncModal, setSyncModal] = useState({ show: false, mode: null, code: null, loading: false, error: null }); // åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ«
      const [syncCodeInput, setSyncCodeInput] = useState(''); // åŒæœŸã‚³ãƒ¼ãƒ‰å…¥åŠ›
      const [editingItem, setEditingItem] = useState(null); // ç·¨é›†ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ  { id, title }
      const [actionMenu, setActionMenu] = useState(null); // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã‚¢ã‚¤ãƒ†ãƒ 
      const showPasteButton = useMemo(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get('paste') === '1';
      }, []);
      const containerRef = useRef(null);
      const isDragging = useRef(false);
      const longPressTimer = useRef(null);
      const textareaRef = useRef(null);
      const fileInputRef = useRef(null);
      const importInputRef = useRef(null);
      const libraryLongPressTimer = useRef(null);
      const libraryLongPressTriggered = useRef(false);
      const libraryTouchStart = useRef({ x: 0, y: 0 });
      // ã‚¿ãƒ–ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªâ†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®2ã‚¿ãƒ–ï¼‰
      const tabOrder = ['library', 'preview'];
      const swipeState = useRef({ startX: 0, startY: 0, isSwiping: false, isLocked: false });

      // ã‚¿ãƒ–ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹ï¼ˆã‚¨ãƒƒã‚¸ã‚¹ãƒ¯ã‚¤ãƒ—ï¼šç”»é¢ç«¯30pxã‹ã‚‰ã®ã¿æœ‰åŠ¹ï¼‰
      const EDGE_WIDTH = 30;
      const handleTabSwipeStart = useCallback((e) => {
        const touch = e.touches[0];
        const screenWidth = window.innerWidth;
        const isFromEdge = touch.clientX < EDGE_WIDTH || touch.clientX > screenWidth - EDGE_WIDTH;

        swipeState.current = {
          startX: touch.clientX,
          startY: touch.clientY,
          isSwiping: false,
          isLocked: !isFromEdge // ã‚¨ãƒƒã‚¸ä»¥å¤–ã‹ã‚‰ã®é–‹å§‹ã¯ãƒ­ãƒƒã‚¯
        };
      }, []);

      // ã‚¿ãƒ–ã‚¹ãƒ¯ã‚¤ãƒ—ç§»å‹•
      const handleTabSwipeMove = useCallback((e) => {
        const state = swipeState.current;
        if (state.isLocked) return;

        const touch = e.touches[0];
        const dx = touch.clientX - state.startX;
        const dy = touch.clientY - state.startY;

        // æœ€åˆã®ç§»å‹•ã§æ–¹å‘ã‚’åˆ¤å®š
        if (!state.isSwiping && (Math.abs(dx) > 15 || Math.abs(dy) > 15)) {
          if (Math.abs(dy) > Math.abs(dx)) {
            state.isLocked = true; // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆ
            return;
          }
          state.isSwiping = true;
        }
      }, []);

      // ã‚¿ãƒ–ã‚¹ãƒ¯ã‚¤ãƒ—çµ‚äº†
      const handleTabSwipeEnd = useCallback((e) => {
        const state = swipeState.current;
        if (!state.isSwiping) return;

        const touch = e.changedTouches[0];
        const dx = touch.clientX - state.startX;
        const threshold = 80; // ã‚¹ãƒ¯ã‚¤ãƒ—é–¾å€¤

        const currentIndex = tabOrder.indexOf(activeTab);

        if (dx < -threshold && currentIndex < tabOrder.length - 1) {
          setActiveTab(tabOrder[currentIndex + 1]);
          if (navigator.vibrate) navigator.vibrate(10);
        } else if (dx > threshold && currentIndex > 0) {
          setActiveTab(tabOrder[currentIndex - 1]);
          if (navigator.vibrate) navigator.vibrate(10);
        }

        swipeState.current = { startX: 0, startY: 0, isSwiping: false, isLocked: false };
      }, [activeTab]);

      // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé•·æŠ¼ã—é–‹å§‹
      const handleLibraryTouchStart = useCallback((e, item) => {
        const touch = e.touches[0];
        libraryTouchStart.current = { x: touch.clientX, y: touch.clientY };
        libraryLongPressTriggered.current = false;
        libraryLongPressTimer.current = setTimeout(() => {
          libraryLongPressTriggered.current = true;
          if (navigator.vibrate) navigator.vibrate(50);
          setActionMenu(item);
        }, 500);
      }, []);

      // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé•·æŠ¼ã—çµ‚äº†
      const handleLibraryTouchEnd = useCallback(() => {
        if (libraryLongPressTimer.current) {
          clearTimeout(libraryLongPressTimer.current);
          libraryLongPressTimer.current = null;
        }
      }, []);

      // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¿ãƒƒãƒç§»å‹•ï¼ˆ10pxä»¥ä¸Šã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
      const handleLibraryTouchMove = useCallback((e) => {
        if (!libraryLongPressTimer.current) return;
        const touch = e.touches[0];
        const dx = touch.clientX - libraryTouchStart.current.x;
        const dy = touch.clientY - libraryTouchStart.current.y;
        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
          clearTimeout(libraryLongPressTimer.current);
          libraryLongPressTimer.current = null;
        }
      }, []);

      // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¢ã‚¤ãƒ†ãƒ ã‚¿ãƒƒãƒ—ï¼ˆé•·æŠ¼ã—ã§ãªã‘ã‚Œã°ãƒ­ãƒ¼ãƒ‰ï¼‰
      const handleLibraryTap = useCallback((item) => {
        if (libraryLongPressTriggered.current) {
          libraryLongPressTriggered.current = false;
          return;
        }
        handleLoad(item);
      }, []);

      // ã‚³ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¹ãƒˆæ¤œçŸ¥â†’è‡ªå‹•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é·ç§»
      const handleCodePaste = useCallback((e) => {
        // ãƒšãƒ¼ã‚¹ãƒˆå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«é·ç§»
        setTimeout(() => {
          setActiveTab('preview');
          if (navigator.vibrate) navigator.vibrate(10);
        }, 300);
      }, []);

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰- ç”»åƒ/HTML/PDFå¯¾å¿œ
      const handleFileSelect = useCallback((e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        const fileType = file.type;

        // HTMLãƒ•ã‚¡ã‚¤ãƒ«: ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ç½®ãæ›ãˆ
        if (fileName.endsWith('.html') || fileName.endsWith('.htm') || fileType === 'text/html') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'HTML' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsText(file);
        }
        // SVGãƒ•ã‚¡ã‚¤ãƒ«: ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ç½®ãæ›ãˆ
        else if (fileName.endsWith('.svg') || fileType === 'image/svg+xml') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'SVG' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsText(file);
        }
        // PDFãƒ•ã‚¡ã‚¤ãƒ«: PDF.jsã§ç”»åƒåŒ–
        else if (fileName.endsWith('.pdf') || fileType === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const arrayBuffer = event.target.result;
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

              // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
              let pdfTitle = file.name;
              try {
                const metadata = await pdf.getMetadata();
                if (metadata?.info?.Title) {
                  pdfTitle = metadata.info.Title;
                }
              } catch (e) {}

              const images = [];
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const scale = 2;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport }).promise;
                const imgData = canvas.toDataURL('image/png');
                images.push(`<img src="${imgData}" alt="Page ${i}" style="max-width:100%;height:auto;margin-bottom:10px;">`);
              }

              setCode(images.join('\n'));
              setLoadedFile({ name: pdfTitle, type: 'PDF' });
              if (navigator.vibrate) navigator.vibrate(50);
            } catch (err) {
              console.error('PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
              alert('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          };
          reader.readAsArrayBuffer(file);
        }
        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: base64ã§imgæŒ¿å…¥
        else if (fileType.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            const imgTag = `<img src="${base64}" alt="${file.name}" style="max-width:100%;height:auto;">`;
            // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ 
            setCode(code + (code ? '\n' : '') + imgTag);
            setLoadedFile({ name: file.name, type: 'IMAGE' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsDataURL(file);
        }

        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ã™ã‚‹
        e.target.value = '';
      }, [code]);

      // é•·æŠ¼ã—ã§ãƒšãƒ¼ã‚¹ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
      const handleLongPressStart = useCallback((e) => {
        if (!isMobile) return;
        longPressTimer.current = setTimeout(async () => {
          try {
            const text = await navigator.clipboard.readText();
            if (text) {
              setCode(text);
              // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
              if (navigator.vibrate) navigator.vibrate(50);
            }
          } catch (err) {
            console.warn('Clipboard read failed:', err);
          }
        }, 500);
      }, [isMobile]);

      const handleLongPressEnd = useCallback(() => {
        if (longPressTimer.current) {
          clearTimeout(longPressTimer.current);
          longPressTimer.current = null;
        }
      }, []);

      // ãƒšãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³ç”¨ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
      const handlePaste = useCallback(async () => {
        // ã¾ãšClipboard APIã‚’è©¦ã™
        try {
          const text = await navigator.clipboard.readText();
          if (text) {
            setCode(text);
            if (navigator.vibrate) navigator.vibrate(50);
            // è‡ªå‹•ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«é·ç§»
            setTimeout(() => setActiveTab('preview'), 300);
            return;
          }
        } catch (err) {
          console.warn('Clipboard API failed:', err);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦execCommandã‚’è©¦ã™
        if (textareaRef.current) {
          textareaRef.current.focus();
          try {
            const success = document.execCommand('paste');
            if (success) {
              if (navigator.vibrate) navigator.vibrate(50);
              // è‡ªå‹•ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«é·ç§»
              setTimeout(() => setActiveTab('preview'), 300);
              return;
            }
          } catch (e) {
            console.warn('execCommand paste failed:', e);
          }
          // ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é•·æŠ¼ã—ã‚’ä¿ƒã™
          // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒé–‹ãã®ã§ã€ãã“ã‹ã‚‰é•·æŠ¼ã—ã§ãƒšãƒ¼ã‚¹ãƒˆå¯èƒ½
        }
      }, []);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«UIè¡¨ç¤º/éè¡¨ç¤º
      const handlePreviewScroll = useCallback((e) => {
        const currentY = e.target.scrollTop;
        const diff = currentY - lastScrollY.current;

        // 20pxä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§åˆ¤å®š
        if (diff > 20) {
          // ä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â†’ UIéè¡¨ç¤º
          setHideUI(true);
        } else if (diff < -20) {
          // ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â†’ UIè¡¨ç¤º
          setHideUI(false);
        }

        lastScrollY.current = currentY;
      }, []);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚¿ãƒƒãƒ—ã§UIè¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆiframeç”¨ï¼‰
      const handlePreviewTap = useCallback((e) => {
        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—çš„ãªå‹•ä½œã‚’é˜²ããŸã‚ã€ãƒœã‚¿ãƒ³ç­‰ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
        setHideUI(prev => !prev);
      }, []);

      // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆå¤§é‡ãƒ†ã‚­ã‚¹ãƒˆå¯¾ç­–ï¼‰
      useEffect(() => {
        const timer = setTimeout(() => {
          setDebouncedCode(code);
        }, 300);
        return () => clearTimeout(timer);
      }, [code]);

      // ç”»é¢ã‚µã‚¤ã‚ºæ¤œå‡º
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth < 768);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«UIè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      useEffect(() => {
        setHideUI(false);
        lastScrollY.current = 0;
      }, [activeTab]);

      // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
      useEffect(() => {
        try {
          const saved = localStorage.getItem('html-preview-library');
          if (saved) {
            setSavedItems(JSON.parse(saved));
          }
        } catch (e) {
          console.error('Failed to load from localStorage:', e);
        }
      }, []);

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ#ã‚’ä½¿ç”¨ï¼‰
      useEffect(() => {
        try {
          const hash = window.location.hash;
          if (hash && hash.startsWith('#data=')) {
            const data = hash.slice(6); // '#data=' ã‚’é™¤å»
            // lz-stringã§è§£å‡
            const decoded = LZString.decompressFromEncodedURIComponent(data);
            if (decoded) {
              setCode(decoded);
              setActiveTab('preview');
            }
            // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹ï¼ˆå±¥æ­´ã‚’æ®‹ã•ãšï¼‰
            window.history.replaceState({}, '', window.location.pathname);
          }
        } catch (e) {
          console.error('Failed to load from URL:', e);
        }
      }, []);

      // SVGã‚¿ã‚°ã‚’æŠ½å‡º
      const extractSvgTag = (text) => {
        const match = text.match(/<svg[\s\S]*<\/svg>/i);
        return match ? match[0] : text;
      };

      // SVGã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ï¼‰
      const extractSvgTexts = (svgString) => {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(svgString, 'image/svg+xml');
          const texts = [];
          doc.querySelectorAll('text').forEach(text => {
            const content = text.textContent?.trim();
            if (content) texts.push(content);
          });
          return texts;
        } catch (e) {
          return [];
        }
      };

      // ç™»éŒ²æ©Ÿèƒ½
      const handleSave = useCallback(() => {
        if (!code.trim()) return;

        const trimmed = code.trim();
        // HTMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ<!DOCTYPE, <htmlï¼‰ã¯ä¸­ã«SVGãŒã‚ã£ã¦ã‚‚HTMLæ‰±ã„
        const isHtmlDoc = trimmed.startsWith('<!DOCTYPE') || trimmed.startsWith('<html') || trimmed.startsWith('<HTML');
        // ç´”ç²‹ãªSVGã¯<svgã¾ãŸã¯<?xmlã§å§‹ã¾ã‚‹å ´åˆã®ã¿
        const isSvg = !isHtmlDoc && (trimmed.startsWith('<svg') || trimmed.startsWith('<?xml'));
        const isHtml = trimmed.startsWith('<');
        // loadedFileãŒã‚ã‚Œã°ãã®ã‚¿ã‚¤ãƒ—ã‚’å„ªå…ˆ
        const type = loadedFile?.type || (isSvg ? 'SVG' : isHtml ? 'HTML' : 'TEXT');
        const content = isSvg ? extractSvgTag(trimmed) : code;
        let title = '';

        // loadedFileãŒã‚ã‚Œã°ãã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å„ªå…ˆ
        if (loadedFile?.name) {
          title = loadedFile.name;
        }
        // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ï¼ˆloadedFileãŒãªã„å ´åˆï¼‰
        else if (isSvg) {
          // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—
          const match = content.match(/<!--\s*ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
          if (match && match[1]) {
            title = match[1].trim();
          }
          // ãªã‘ã‚Œã°æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ 
          if (!title) {
            const texts = extractSvgTexts(content);
            if (texts.length > 0) title = texts[0];
          }
        } else if (type === 'HTML') {
          // HTMLã®å ´åˆã¯<title>ã‚¿ã‚°ã‹ã‚‰å–å¾—
          const titleMatch = code.match(/<title[^>]*>([^<]+)<\/title>/i);
          if (titleMatch && titleMatch[1]) {
            title = titleMatch[1].trim();
          }
        } else if (type === 'TEXT') {
          // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯æœ€åˆã®è¡Œã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«
          const firstLine = code.trim().split('\n')[0];
          title = firstLine;
        }
        title = title.slice(0, 50).replace(/[\/\\:*?"<>|\n\r]/g, '').trim() || type;

        const newItem = {
          id: Date.now(),
          title,
          type,
          code: content,
          createdAt: new Date().toISOString()
        };

        const updated = [newItem, ...savedItems];
        setSavedItems(updated);
        localStorage.setItem('html-preview-library', JSON.stringify(updated));
        alert('ç™»éŒ²ã—ã¾ã—ãŸï¼');
      }, [code, savedItems, loadedFile]);

      // å‰Šé™¤æ©Ÿèƒ½
      const handleDelete = useCallback((id) => {
        setConfirmDialog({
          show: true,
          message: 'å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
          onConfirm: () => {
            const updated = savedItems.filter(item => item.id !== id);
            setSavedItems(updated);
            localStorage.setItem('html-preview-library', JSON.stringify(updated));
            setConfirmDialog({ show: false, message: '', onConfirm: null });
          }
        });
      }, [savedItems]);

      // ã‚¹ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
      const toggleStar = useCallback((id) => {
        const updated = savedItems.map(item =>
          item.id === id ? { ...item, starred: !item.starred } : item
        );
        setSavedItems(updated);
        localStorage.setItem('html-preview-library', JSON.stringify(updated));
        if (navigator.vibrate) navigator.vibrate(30);
      }, [savedItems]);

      // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
      const updateTitle = useCallback((id, newTitle) => {
        if (!newTitle.trim()) return;
        const updated = savedItems.map(item =>
          item.id === id ? { ...item, title: newTitle.trim() } : item
        );
        setSavedItems(updated);
        localStorage.setItem('html-preview-library', JSON.stringify(updated));
        setEditingItem(null);
        if (navigator.vibrate) navigator.vibrate(30);
      }, [savedItems]);

      // èª­ã¿è¾¼ã¿æ©Ÿèƒ½
      const handleLoad = useCallback((item) => {
        setCode(item.code);
        setActiveTab('preview');
      }, []);

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆJSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      const handleExport = useCallback(() => {
        const itemsToExport = savedItems.filter(item => selectedItems.has(item.id));
        if (itemsToExport.length === 0) return;
        const data = JSON.stringify(itemsToExport, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `html-preview-library-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¾Œã¯é¸æŠè§£é™¤
        setSelectedItems(new Set());
      }, [savedItems, selectedItems]);

      // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠãƒˆã‚°ãƒ«
      const toggleSelectItem = useCallback((id) => {
        setSelectedItems(prev => {
          const next = new Set(prev);
          if (next.has(id)) {
            next.delete(id);
          } else {
            next.add(id);
          }
          return next;
        });
      }, []);

      // å…¨é¸æŠ/å…¨è§£é™¤
      const toggleSelectAll = useCallback(() => {
        if (selectedItems.size === savedItems.length) {
          setSelectedItems(new Set());
        } else {
          setSelectedItems(new Set(savedItems.map(item => item.id)));
        }
      }, [savedItems, selectedItems]);

      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆJSONèª­ã¿è¾¼ã¿ï¼‰
      const handleImport = useCallback((e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) {
              alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
              return;
            }
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼ˆIDãŒé‡è¤‡ã—ãŸã‚‰ä¸Šæ›¸ãï¼‰
            const existingIds = new Set(savedItems.map(item => item.id));
            const newItems = imported.filter(item => !existingIds.has(item.id));
            const merged = [...imported.filter(item => existingIds.has(item.id)), ...savedItems.filter(item => !imported.find(i => i.id === item.id)), ...newItems];
            // IDã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            merged.sort((a, b) => b.id - a.id);
            setSavedItems(merged);
            localStorage.setItem('html-preview-library', JSON.stringify(merged));
            alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ï¼ˆ${imported.length}ä»¶ï¼‰`);
            if (navigator.vibrate) navigator.vibrate(50);
          } catch (err) {
            console.error('Import error:', err);
            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      }, [savedItems]);

      // åŒæœŸã‚³ãƒ¼ãƒ‰ç™ºè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼‰
      const generateSyncCode = useCallback(async () => {
        const itemsToExport = savedItems.filter(item => selectedItems.has(item.id));
        if (itemsToExport.length === 0) return;

        setSyncModal({ show: true, mode: 'generate', code: null, loading: true, error: null, count: itemsToExport.length });
        setSelectedItems(new Set());

        try {
          const json = JSON.stringify(itemsToExport);
          const response = await fetch(`${SYNC_URL}/sync`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: json
          });
          const result = await response.json();

          if (result.code) {
            setSyncModal(prev => ({ ...prev, loading: false, code: result.code }));
          } else {
            throw new Error(result.error || 'Unknown error');
          }
        } catch (err) {
          console.error('Sync error:', err);
          setSyncModal(prev => ({ ...prev, loading: false, error: 'ã‚³ãƒ¼ãƒ‰ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ' }));
        }
      }, [savedItems, selectedItems]);

      // åŒæœŸã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      const openSyncInput = useCallback(() => {
        setSyncCodeInput('');
        setSyncModal({ show: true, mode: 'input', code: null, loading: false, error: null });
      }, []);

      // åŒæœŸã‚³ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const fetchSyncData = useCallback(async () => {
        if (!/^\d{4}$/.test(syncCodeInput)) {
          setSyncModal(prev => ({ ...prev, error: '4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' }));
          return;
        }

        setSyncModal(prev => ({ ...prev, loading: true, error: null }));

        try {
          const response = await fetch(`${SYNC_URL}/sync/${syncCodeInput}`);
          const result = await response.json();

          if (result.data) {
            const imported = JSON.parse(result.data);
            if (!Array.isArray(imported)) throw new Error('Invalid format');

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
            const existingIds = new Set(savedItems.map(item => item.id));
            const newItems = imported.filter(item => !existingIds.has(item.id));
            const merged = [...imported.filter(item => existingIds.has(item.id)), ...savedItems.filter(item => !imported.find(i => i.id === item.id)), ...newItems];
            merged.sort((a, b) => b.id - a.id);
            setSavedItems(merged);
            localStorage.setItem('html-preview-library', JSON.stringify(merged));

            setSyncModal({ show: false, mode: null, code: null, loading: false, error: null });
            alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ï¼ˆ${imported.length}ä»¶ï¼‰`);
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          } else {
            throw new Error(result.error || 'ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        } catch (err) {
          console.error('Sync fetch error:', err);
          setSyncModal(prev => ({ ...prev, loading: false, error: err.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }));
        }
      }, [syncCodeInput, savedItems]);

      // åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      const closeSyncModal = useCallback(() => {
        setSyncModal({ show: false, mode: null, code: null, loading: false, error: null });
        setSyncCodeInput('');
      }, []);

      // URLå…±æœ‰æ©Ÿèƒ½ï¼ˆãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆ#ã‚’ä½¿ç”¨ - ã‚ˆã‚Šé•·ã„ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œï¼‰
      const [isShortening, setIsShortening] = useState(false);

      const handleShare = useCallback(async () => {
        if (!code.trim()) return;

        try {
          const isSvg = code.includes('<svg');
          const content = isSvg ? extractSvgTag(code.trim()) : code;
          // lz-stringã§åœ§ç¸®ï¼ˆURLå®‰å…¨ï¼‰
          const compressed = LZString.compressToEncodedURIComponent(content);
          let shareUrl = `${window.location.origin}${window.location.pathname}#data=${compressed}`;

          // çŸ­ç¸®URLã‚µãƒ¼ãƒ“ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ä½¿ç”¨
          if (SHORTENER_URL) {
            setIsShortening(true);
            try {
              const response = await fetch(`${SHORTENER_URL}?url=${encodeURIComponent(shareUrl)}`);
              const data = await response.json();
              if (data.shortUrl) {
                shareUrl = data.shortUrl;
              }
            } catch (e) {
              console.warn('URL shortening failed, using original URL:', e);
            } finally {
              setIsShortening(false);
            }
          }

          // å…±æœ‰å‡¦ç†ï¼ˆWeb Share API â†’ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ â†’ promptï¼‰
          const sizeInfo = shareUrl.length < 100 ? 'çŸ­ç¸®æ¸ˆã¿' : `${Math.round(shareUrl.length/1000)}KB`;

          // ãƒ¢ãƒã‚¤ãƒ«ã§Web Share APIå¯¾å¿œãªã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–å…±æœ‰ã‚’ä½¿ç”¨
          if (navigator.share && isMobile) {
            try {
              await navigator.share({
                title: 'HTML/SVG Preview',
                text: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…±æœ‰',
                url: shareUrl
              });
              return; // å…±æœ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã„ãŸã‚‰çµ‚äº†
            } catch (shareError) {
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
              if (shareError.name === 'AbortError') return;
              console.warn('Web Share API failed:', shareError);
            }
          }

          // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¾ãŸã¯Web Shareå¤±æ•—æ™‚ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
          try {
            await navigator.clipboard.writeText(shareUrl);
            alert(`å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ï¼ˆ${sizeInfo}ï¼‰\nã“ã®URLã‚’é€ã‚‹ã ã‘ã§èª°ã§ã‚‚åŒã˜å†…å®¹ã‚’è¦‹ã‚Œã¾ã™ã€‚`);
          } catch (clipboardError) {
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚‚å¤±æ•—ã—ãŸå ´åˆã€é¸æŠå¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤º
            console.warn('Clipboard API failed:', clipboardError);
            alert(`å…±æœ‰URLï¼ˆ${sizeInfo}ï¼‰:\n\n${shareUrl}\n\nâ†‘ã“ã®URLã‚’é•·æŠ¼ã—ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„`);
          }
        } catch (e) {
          console.error('Failed to create share URL:', e);
          alert('å…±æœ‰URLã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }, [code, isMobile]);

      // SVGã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã€å¿…è¦ãªã‚‰HTMLã§ãƒ©ãƒƒãƒ—
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹é©ç”¨ï¼‰
      const previewCode = useMemo(() => {
        const trimmed = debouncedCode.trim();
        // HTMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºï¼ˆä¸­ã«SVGãŒã‚ã£ã¦ã‚‚HTMLæ‰±ã„ï¼‰
        const isHtmlDoc = trimmed.startsWith('<!DOCTYPE') || trimmed.startsWith('<html') || trimmed.startsWith('<HTML');
        // ç´”ç²‹ãªSVGã®å ´åˆã®ã¿SVGå‡¦ç†
        const isSvg = !isHtmlDoc && (trimmed.startsWith('<svg') || trimmed.startsWith('<?xml'));

        if (isSvg) {
          const svgOnly = extractSvgTag(trimmed);
          return `<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    svg {
      max-width: 100%;
      max-height: 100vh;
      width: auto;
      height: auto;
    }
  </style>
</head>
<body>
  ${svgOnly}
</body>
</html>`;
        }
        return debouncedCode;
      }, [debouncedCode]);

      // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®šï¼ˆå…ˆé ­æ–‡å­—ã§è‡ªå‹•åˆ¤å®šï¼‰
      const currentMode = useMemo(() => {
        const trimmed = debouncedCode.trim();

        // å…ˆé ­ãŒ<ã§å§‹ã¾ã‚‰ãªã„ â†’ TEXT
        if (!trimmed.startsWith('<')) {
          return 'TEXT';
        }

        // HTMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ<!DOCTYPE, <htmlï¼‰â†’ HTMLï¼ˆä¸­ã«SVGãŒã‚ã£ã¦ã‚‚HTMLï¼‰
        if (trimmed.startsWith('<!DOCTYPE') || trimmed.startsWith('<html') || trimmed.startsWith('<HTML')) {
          return 'HTML';
        }

        // ç´”ç²‹ãªSVGï¼ˆ<svg or <?xml ã§å§‹ã¾ã‚‹ï¼‰â†’ SVG
        if (trimmed.startsWith('<svg') || trimmed.startsWith('<?xml')) {
          return 'SVG';
        }

        return 'HTML';
      }, [debouncedCode]);

      // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
      const handleMouseDown = useCallback((e) => {
        isDragging.current = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      }, []);

      const handleMouseMove = useCallback((e) => {
        if (!isDragging.current || !containerRef.current) return;
        const container = containerRef.current;
        const rect = container.getBoundingClientRect();
        const newWidth = ((e.clientX - rect.left) / rect.width) * 100;
        if (newWidth >= 20 && newWidth <= 80) {
          setLeftPanelWidth(newWidth);
        }
      }, []);

      const handleMouseUp = useCallback(() => {
        isDragging.current = false;
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
      }, []);

      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ï¼‰
      const handleTouchStart = useCallback((e) => {
        isDragging.current = true;
      }, []);

      const handleTouchMove = useCallback((e) => {
        if (!isDragging.current || !containerRef.current) return;
        const touch = e.touches[0];
        const container = containerRef.current;
        const rect = container.getBoundingClientRect();
        const newWidth = ((touch.clientX - rect.left) / rect.width) * 100;
        if (newWidth >= 20 && newWidth <= 80) {
          setLeftPanelWidth(newWidth);
        }
      }, []);

      const handleTouchEnd = useCallback(() => {
        isDragging.current = false;
      }, []);

      // PNGå¤‰æ›ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆSVGã®ã¿ï¼‰
      const handleDownloadPng = useCallback(async () => {
        if (currentMode !== 'SVG') return;

        try {
          let svgContent = extractSvgTag(code.trim());
          if (!svgContent) return;

          // SVGã®ã‚µã‚¤ã‚ºã‚’å–å¾—
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
          const svgEl = svgDoc.querySelector('svg');

          if (!svgEl) {
            alert('SVGã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }

          // viewBoxã‹ã‚‰ã‚µã‚¤ã‚ºå–å¾—ã‚’è©¦ã¿ã‚‹
          let width, height;
          const viewBox = svgEl.getAttribute('viewBox');
          if (viewBox) {
            const parts = viewBox.split(/\s+|,/).map(Number);
            width = parts[2] || 800;
            height = parts[3] || 600;
          } else {
            width = parseInt(svgEl.getAttribute('width')) || 800;
            height = parseInt(svgEl.getAttribute('height')) || 600;
          }

          // SVGã«width/heightå±æ€§ã‚’ç¢ºå®Ÿã«è¨­å®šï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
          svgEl.setAttribute('width', width);
          svgEl.setAttribute('height', height);
          svgContent = new XMLSerializer().serializeToString(svgEl);

          // é«˜è§£åƒåº¦å¯¾å¿œï¼ˆ2å€ï¼‰
          const scale = 2;

          // Canvasã‚’ä½œæˆ
          const canvas = document.createElement('canvas');
          canvas.width = width * scale;
          canvas.height = height * scale;
          const ctx = canvas.getContext('2d');
          ctx.scale(scale, scale);

          // èƒŒæ™¯ã‚’ç™½ã«
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, width, height);

          // SVGã‚’data URLã«å¤‰æ›ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
          const svgBase64 = btoa(unescape(encodeURIComponent(svgContent)));
          const dataUrl = `data:image/svg+xml;base64,${svgBase64}`;

          // SVGã‚’Imageã¨ã—ã¦èª­ã¿è¾¼ã¿
          const img = new Image();

          img.onload = () => {
            ctx.drawImage(img, 0, 0, width, height);

            // PNGã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const pngUrl = canvas.toDataURL('image/png');

            // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
            const now = new Date();
            const timestamp = now.getFullYear().toString() +
              String(now.getMonth() + 1).padStart(2, '0') +
              String(now.getDate()).padStart(2, '0');

            let title = '';
            const match = code.match(/<!--\s*ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
            if (match && match[1]) {
              title = match[1].trim();
            }
            if (!title) {
              const texts = extractSvgTexts(code.trim());
              if (texts.length > 0) title = texts[0];
            }
            title = title.slice(0, 30).replace(/[\/\\:*?"<>|\n\r]/g, '').trim() || 'svg';

            // PWAã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰æ¤œå‡º
            const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone === true;

            // ãƒ¢ãƒã‚¤ãƒ«ã¾ãŸã¯PWAã§ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆé•·æŠ¼ã—/å³ã‚¯ãƒªãƒƒã‚¯ä¿å­˜ç”¨ï¼‰
            if (isMobile || isPWA) {
              const modal = document.createElement('div');
              modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
              modal.innerHTML = `
                <p style="color:white;font-size:16px;margin-bottom:16px;text-align:center;">${isMobile ? 'ğŸ“± ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜' : 'ğŸ–±ï¸ ç”»åƒã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜'}</p>
                <img src="${pngUrl}" style="max-width:90%;max-height:70vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);" />
                <button style="margin-top:20px;padding:12px 32px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:16px;">é–‰ã˜ã‚‹</button>
              `;
              modal.querySelector('button').onclick = () => modal.remove();
              modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
              document.body.appendChild(modal);
            } else {
              const a = document.createElement('a');
              a.href = pngUrl;
              a.download = `${timestamp}_${title}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          };

          img.onerror = (e) => {
            console.error('Image load error:', e);
            alert('PNGå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼‰');
          };

          img.src = dataUrl;
        } catch (e) {
          console.error('PNG conversion failed:', e);
          alert('PNGå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
      }, [code, currentMode]);

      const handleDownload = useCallback(async () => {
        const isSvg = currentMode === 'SVG';
        // UTF-8 BOMã‚’è¿½åŠ ã—ã¦æ–‡å­—åŒ–ã‘é˜²æ­¢
        const BOM = '\uFEFF';
        // SVGã®å ´åˆã¯ã‚¿ã‚°ã ã‘æŠ½å‡º
        const content = isSvg ? extractSvgTag(code.trim()) : code;
        const blob = new Blob([BOM + content], {
          type: isSvg ? 'image/svg+xml;charset=utf-8' : 'text/html;charset=utf-8'
        });

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ (YYYYMMDD)
        const now = new Date();
        const timestamp = now.getFullYear().toString() +
          String(now.getMonth() + 1).padStart(2, '0') +
          String(now.getDate()).padStart(2, '0');

        // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆ<!--ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«-->ã‚³ãƒ¡ãƒ³ãƒˆã®ç›´å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        let title = '';
        if (isSvg) {
          try {
            // æ­£è¦è¡¨ç¾ã§ <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« --> ã®ç›´å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’æ¢ã™ï¼ˆæ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
            const match = code.match(/<!--\s*ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
            if (match && match[1]) {
              title = match[1].trim();
            }

            // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ 
            if (!title) {
              const texts = extractSvgTexts(code.trim());
              if (texts.length > 0) {
                title = texts[0];
              }
            }
          } catch (e) {}
        }
        // ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ãˆãªã„æ–‡å­—ã‚’é™¤å»ã€æœ€å¤§30æ–‡å­—
        title = title
          .slice(0, 30)
          .replace(/[\/\\:*?"<>|\n\r]/g, '')
          .trim() || (isSvg ? 'svg' : 'html');

        const filename = `${timestamp}_${title}.${isSvg ? 'svg' : 'html'}`;

        // PWAã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰æ¤œå‡º
        const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                      window.navigator.standalone === true;

        // PWAãƒ¢ãƒ¼ãƒ‰ã§ã¯Web Share APIã‚’è©¦ã™
        if (isPWA && navigator.canShare) {
          try {
            const file = new File([blob], filename, { type: blob.type });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: filename
              });
              return;
            }
          } catch (e) {
            // ã‚·ã‚§ã‚¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (e.name === 'AbortError') return;
            // ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯é€šå¸¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          }
        }

        // é€šå¸¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, [code, currentMode]);

      // å°åˆ·æ©Ÿèƒ½ï¼ˆæ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã„ã¦å…¨ãƒšãƒ¼ã‚¸å°åˆ·å¯èƒ½ã«ï¼‰
      const handlePrint = useCallback(() => {
        const isSvg = currentMode === 'SVG';
        const content = isSvg ? extractSvgTag(code.trim()) : code;

        // å°åˆ·ç”¨ã®HTMLã‚’ä½œæˆï¼ˆå…¨ãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼‰
        const printHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
  <style>
    @media print {
      body { margin: 0; padding: 20px; }
      @page { margin: 15mm; }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
    }
  </style>
</head>
<body>
${content}
</body>
</html>`;

        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(printHtml);
          printWindow.document.close();
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
          setTimeout(() => {
            printWindow.print();
          }, 300);
        }
      }, [code, currentMode]);

      // ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
      if (isMobile) {
        return (
          <div
            className="flex flex-col h-screen bg-gray-900 overflow-hidden"
          >
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ™‚ã®ã¿è¡¨ç¤ºã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§éè¡¨ç¤ºï¼‰ */}
            {!isFullscreen && loadedFile && (
            <div className={`bg-gray-800 px-4 py-2 flex items-center gap-2 border-b border-gray-700 ${activeTab === 'preview' && hideUI ? 'hidden' : ''}`}>
              <span className={`px-2 py-0.5 text-xs rounded font-medium flex-shrink-0 ${
                loadedFile.type === 'PDF'
                  ? 'bg-red-600 text-white'
                  : loadedFile.type === 'SVG'
                  ? 'bg-purple-600 text-white'
                  : loadedFile.type === 'IMAGE'
                  ? 'bg-green-600 text-white'
                  : 'bg-blue-600 text-white'
              }`}>
                {loadedFile.type}
              </span>
              <span className="text-white text-sm truncate" title={loadedFile.name}>
                {loadedFile.name}
              </span>
            </div>
            )}
            {/* hidden file input */}
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*,.html,.htm,.svg,.pdf"
              onChange={handleFileSelect}
              className="hidden"
            />


            {/* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œç´¢ãƒãƒ¼ */}
            {activeTab === 'library' && !isFullscreen && (
              <div className="bg-gray-900 px-4 py-2 border-b border-gray-700">
                <div className="flex items-center gap-2">
                  <div className="relative flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¤œç´¢..."
                      className="w-full pl-10 pr-10 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-yellow-500"
                    />
                    {searchQuery && (
                      <button
                        onClick={() => setSearchQuery('')}
                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                  {/* â˜…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */}
                  <button
                    onClick={() => setShowStarredOnly(!showStarredOnly)}
                    className={`p-2 rounded-lg border transition flex-shrink-0 ${
                      showStarredOnly
                        ? 'bg-yellow-500/20 border-yellow-500 text-yellow-400'
                        : 'bg-gray-800 border-gray-700 text-gray-500 hover:text-yellow-400'
                    }`}
                    title={showStarredOnly ? 'å…¨ã¦è¡¨ç¤º' : 'â˜…ã®ã¿è¡¨ç¤º'}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill={showStarredOnly ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                  </button>
                </div>
              </div>
            )}

            {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—å¯¾å¿œï¼‰ */}
            <div
              className="flex-1 overflow-hidden relative"
              onTouchStartCapture={handleTabSwipeStart}
              onTouchMoveCapture={handleTabSwipeMove}
              onTouchEndCapture={handleTabSwipeEnd}
            >
              {activeTab === 'code' ? (
                <div className="flex flex-col w-full h-full">
                  {/* ã‚³ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                  <div className="flex items-center justify-between px-2 py-1.5 bg-gray-800 border-b border-gray-700">
                    <button
                      onClick={() => setActiveTab('preview')}
                      className="flex items-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg transition active:scale-95"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    </button>
                    <span className="text-gray-400 text-sm">ã‚³ãƒ¼ãƒ‰ç·¨é›†</span>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition active:scale-95"
                      title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                      </svg>
                    </button>
                  </div>
                  {/* ã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */}
                  <div className="relative flex-1">
                    <textarea
                      ref={textareaRef}
                      value={code}
                      onChange={(e) => setCode(e.target.value)}
                      onPaste={handleCodePaste}
                      onTouchStart={handleLongPressStart}
                      onTouchEnd={handleLongPressEnd}
                      onTouchMove={handleLongPressEnd}
                      className="w-full h-full bg-gray-950 text-green-400 font-mono text-base leading-relaxed p-4 resize-none focus:outline-none selection:bg-blue-600 selection:text-white"
                      placeholder="ã“ã“ã«HTMLã¾ãŸã¯SVGã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘..."
                      spellCheck={false}
                      autoCapitalize="off"
                      autoCorrect="off"
                    />
                  {!code && (
                    <button
                      onClick={handlePaste}
                      className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 p-6 bg-indigo-600/90 hover:bg-indigo-500 text-white rounded-2xl transition active:scale-95 shadow-lg"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                      </svg>
                      <span className="text-sm font-medium">ã‚¿ãƒƒãƒ—ã§ãƒšãƒ¼ã‚¹ãƒˆ</span>
                    </button>
                  )}
                  </div>
                </div>
              ) : activeTab === 'library' ? (
                <div className="flex flex-col w-full h-full bg-gray-950">
                  {/* ä¸Šéƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
                  <div className="flex items-center justify-between px-2 py-1.5 bg-gray-800 border-b border-gray-700">
                    <div className="flex gap-1">
                      <button
                        onClick={toggleSelectAll}
                        disabled={savedItems.length === 0}
                        className={`px-3 py-2 text-white text-xs rounded-lg transition active:scale-95 ${savedItems.length === 0 ? 'bg-gray-600 opacity-50' : 'bg-slate-600 hover:bg-slate-500'}`}
                      >
                        {selectedItems.size === savedItems.length && savedItems.length > 0 ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ'}
                      </button>
                      <button
                        onClick={handleExport}
                        disabled={selectedItems.size === 0}
                        className={`px-3 py-2 text-white text-xs rounded-lg transition active:scale-95 ${selectedItems.size === 0 ? 'bg-gray-600 opacity-50' : 'bg-green-600 hover:bg-green-500'}`}
                      >
                        ä¿å­˜
                      </button>
                      <button
                        onClick={generateSyncCode}
                        disabled={selectedItems.size === 0}
                        className={`px-3 py-2 text-white text-xs rounded-lg transition active:scale-95 ${selectedItems.size === 0 ? 'bg-gray-600 opacity-50' : 'bg-indigo-600 hover:bg-indigo-500'}`}
                      >
                        é€ä¿¡
                      </button>
                      <button
                        onClick={() => {
                          if (selectedItems.size > 0) {
                            setConfirmDialog({
                              show: true,
                              message: `${selectedItems.size}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
                              onConfirm: () => {
                                const newItems = savedItems.filter(item => !selectedItems.has(item.id));
                                setSavedItems(newItems);
                                localStorage.setItem('html-preview-saved', JSON.stringify(newItems));
                                setSelectedItems(new Set());
                                setConfirmDialog({ show: false, message: '', onConfirm: null });
                              }
                            });
                          }
                        }}
                        disabled={selectedItems.size === 0}
                        className={`p-2 rounded-lg transition active:scale-95 ${selectedItems.size === 0 ? 'bg-gray-600 opacity-50 text-gray-400' : 'bg-red-600 hover:bg-red-500 text-white'}`}
                        title="é¸æŠé …ç›®ã‚’å‰Šé™¤"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                    <div className="flex gap-1">
                      {/* å—ä¿¡ */}
                      <button
                        onClick={openSyncInput}
                        className="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded-lg transition active:scale-95"
                      >
                        å—ä¿¡
                      </button>
                      {/* JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ */}
                      <input
                        ref={importInputRef}
                        type="file"
                        accept=".json"
                        onChange={handleImport}
                        className="hidden"
                      />
                      <button
                        onClick={() => importInputRef.current?.click()}
                        className="p-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition active:scale-95"
                        title="JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  {/* ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ */}
                  <div className="flex-1 overflow-auto p-4">
                  {(() => {
                    // ã“ã“ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰æ§‹é€ ã‚’ç¶­æŒï¼ˆç©ºã®å ´åˆã®è¡¨ç¤ºãªã©ï¼‰
                    const filtered = savedItems
                      .filter(item => {
                        if (showStarredOnly && !item.starred) return false;
                        if (!searchQuery) return true;
                        const q = searchQuery.toLowerCase();
                        return item.title.toLowerCase().includes(q) ||
                               item.code.toLowerCase().includes(q);
                      })
                      .sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

                    if (filtered.length === 0) {
                      return (
                        <div className="flex flex-col items-center justify-center h-32 text-gray-500">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                          </svg>
                          <p className="text-sm">{searchQuery || showStarredOnly ? 'è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“' : 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ç©ºã§ã™'}</p>
                        </div>
                      );
                    }

                    return (
                      <div className="space-y-2">
                      {filtered.map((item) => (
                        <div
                          key={item.id}
                          className={`flex items-center gap-3 p-3 rounded-lg ${
                            selectedItems.has(item.id)
                              ? 'bg-blue-900/50 border border-blue-500'
                              : 'bg-gray-800 border border-transparent'
                          }`}
                        >
                          {/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */}
                          <div
                            className={`w-6 h-6 rounded border-2 flex items-center justify-center flex-shrink-0 cursor-pointer ${
                              selectedItems.has(item.id) ? 'bg-blue-500 border-blue-500' : 'border-gray-500'
                            }`}
                            onClick={() => toggleSelectItem(item.id)}
                          >
                            {selectedItems.has(item.id) && (
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                          </div>
                          <div
                            className="flex-1 min-w-0 cursor-pointer select-none"
                            onClick={() => handleLibraryTap(item)}
                            onTouchStart={(e) => handleLibraryTouchStart(e, item)}
                            onTouchEnd={handleLibraryTouchEnd}
                            onTouchMove={handleLibraryTouchMove}
                            onTouchCancel={handleLibraryTouchEnd}
                          >
                            <div className="flex items-center gap-2">
                              {item.starred && (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                              )}
                              <h3 className="text-white font-medium text-sm truncate">{item.title}</h3>
                            </div>
                            <p className="text-gray-500 text-xs mt-1">
                              {new Date(item.updatedAt || item.createdAt).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                            </p>
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setActionMenu(item);
                            }}
                            className="p-2 text-gray-400 hover:text-white transition"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="5" r="2"/>
                              <circle cx="12" cy="12" r="2"/>
                              <circle cx="12" cy="19" r="2"/>
                            </svg>
                          </button>
                        </div>
                      ))}
                      </div>
                    );
                  })()}
                  </div>
                </div>
              ) : (
                <div className="flex flex-col w-full h-full">
                  {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */}
                  <div className="relative flex-1 overflow-hidden">
                    {currentMode === 'SVG' ? (
                      <div
                        className="w-full h-full bg-gray-100 overflow-auto p-4"
                        style={{ userSelect: 'text', WebkitUserSelect: 'text' }}
                        onScroll={handlePreviewScroll}
                        dangerouslySetInnerHTML={{ __html: extractSvgTag(debouncedCode.trim()) }}
                      />
                    ) : currentMode === 'TEXT' ? (
                      <div
                        className="w-full h-full bg-white overflow-auto p-4"
                        onScroll={handlePreviewScroll}
                      >
                        <pre className="whitespace-pre-wrap break-words font-sans text-gray-800 text-base leading-relaxed" style={{ userSelect: 'text', WebkitUserSelect: 'text' }}>{debouncedCode}</pre>
                      </div>
                    ) : (
                      <div className="w-full h-full relative">
                        <iframe
                          srcDoc={previewCode}
                          title="Preview"
                          className="w-full h-full border-0 bg-white"
                          sandbox="allow-scripts"
                        />
                        {/* ã‚¿ãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆUIéè¡¨ç¤ºæ™‚ã®ã¿è¡¨ç¤ºï¼‰ */}
                        {hideUI && (
                          <div
                            className="absolute inset-0 bg-transparent"
                            onClick={handlePreviewTap}
                          >
                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1 bg-black/50 text-white text-xs rounded-full">
                              ã‚¿ãƒƒãƒ—ã§UIè¡¨ç¤º
                            </div>
                          </div>
                        )}
                        {/* UIè¡¨ç¤ºæ™‚ï¼šä¸Šéƒ¨ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢ */}
                        {!hideUI && (
                          <div
                            className="absolute top-0 left-0 right-0 h-12 bg-transparent"
                            onClick={handlePreviewTap}
                          />
                        )}
                      </div>
                    )}
                    {/* æœ€å¤§åŒ–æ™‚ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */}
                    {isFullscreen && (
                      <button
                        onClick={() => setIsFullscreen(false)}
                        className="absolute bottom-4 right-4 p-3 bg-gray-800/90 hover:bg-gray-700 text-white rounded-full shadow-lg transition active:scale-95 z-10"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                  {/* ä¸‹éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆæœ€å¤§åŒ–æ™‚ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã¯éè¡¨ç¤ºï¼‰ */}
                  {!isFullscreen && (
                    <div className={`flex items-center justify-between px-2 py-1.5 bg-gray-800 border-t border-gray-700 ${hideUI ? 'hidden' : ''}`}>
                      <div className="flex gap-1">
                        {/* ç™»éŒ²ï¼ˆä¸€ç•ªå·¦ï¼‰ */}
                        <button
                          onClick={handleSave}
                          disabled={!code}
                          className={`p-2 rounded-lg transition active:scale-95 ${code ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-gray-700 text-gray-500'}`}
                          title="ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç™»éŒ²"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                          </svg>
                        </button>
                        {/* ä¸‰ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå…±æœ‰ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»PNGãƒ»å°åˆ·ï¼‰ */}
                        <div className="relative">
                          <button
                            onClick={() => setShowPreviewMenu(!showPreviewMenu)}
                            disabled={!code}
                            className={`p-2 rounded-lg transition active:scale-95 ${code ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-700 text-gray-500'}`}
                            title="ãã®ä»–"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                            </svg>
                          </button>
                          {/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
                          {showPreviewMenu && (
                            <>
                            <div className="fixed inset-0 z-40" onClick={() => setShowPreviewMenu(false)} />
                            <div className="absolute bottom-full left-0 mb-2 bg-gray-900 rounded-lg shadow-xl border border-gray-700 p-1 z-50 flex gap-1">
                              {/* å…±æœ‰ */}
                              <button
                                onClick={() => { handleShare(); setShowPreviewMenu(false); }}
                                disabled={isShortening}
                                className="p-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition active:scale-95"
                                title="å…±æœ‰"
                              >
                                {isShortening ? (
                                  <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                  </svg>
                                ) : (
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                  </svg>
                                )}
                              </button>
                              {/* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ */}
                              <button
                                onClick={() => { handleDownload(); setShowPreviewMenu(false); }}
                                className="p-2 rounded-lg bg-green-600 hover:bg-green-500 text-white transition active:scale-95"
                                title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                              </button>
                              {/* PNGï¼ˆSVGãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ */}
                              {currentMode === 'SVG' && (
                                <button
                                  onClick={() => { handleDownloadPng(); setShowPreviewMenu(false); }}
                                  className="p-2 rounded-lg bg-pink-600 hover:bg-pink-500 text-white transition active:scale-95"
                                  title="PNGå¤‰æ›"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                  </svg>
                                </button>
                              )}
                              {/* å°åˆ· */}
                              <button
                                onClick={() => { handlePrint(); setShowPreviewMenu(false); }}
                                className="p-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white transition active:scale-95"
                                title="å°åˆ·"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                              </button>
                            </div>
                            </>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-1">
                        {/* ã‚¯ãƒªã‚¢ */}
                        <button
                          onClick={() => {
                            if (code) {
                              setConfirmDialog({
                                show: true,
                                message: 'ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ',
                                onConfirm: () => {
                                  setCode('');
                                  setLoadedFile(null);
                                  setConfirmDialog({ show: false, message: '', onConfirm: null });
                                }
                              });
                            }
                          }}
                          disabled={!code}
                          className={`p-2 rounded-lg transition active:scale-95 ${code ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-700 text-gray-500'}`}
                          title="ã‚¯ãƒªã‚¢"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                        {/* ã‚³ãƒ¼ãƒ‰è¡¨ç¤º */}
                        <button
                          onClick={() => setActiveTab('code')}
                          disabled={!code}
                          className={`p-2 rounded-lg transition active:scale-95 ${code ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-gray-700 text-gray-500'}`}
                          title="ã‚³ãƒ¼ãƒ‰è¡¨ç¤º"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                          </svg>
                        </button>
                        {/* æœ€å¤§åŒ– */}
                        <button
                          onClick={() => setIsFullscreen(!isFullscreen)}
                          className="p-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition active:scale-95"
                          title="æœ€å¤§åŒ–"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ–ãƒãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§éè¡¨ç¤ºï¼‰ */}
            {!isFullscreen && activeTab !== 'code' && (
            <div className={`flex bg-gray-800 border-t border-gray-700 ${activeTab === 'preview' && hideUI ? 'hidden' : ''}`}>
              <button
                onClick={() => setActiveTab('library')}
                className={`flex-1 py-3 text-sm font-medium transition ${
                  activeTab === 'library'
                    ? 'text-yellow-400 border-t-2 border-yellow-400 bg-gray-900'
                    : 'text-gray-400 hover:text-gray-300'
                }`}
              >
                <span className="flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  </svg>
                  ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
                  {savedItems.length > 0 && (
                    <span className="bg-yellow-600 text-white text-xs px-1.5 rounded-full">{savedItems.length}</span>
                  )}
                </span>
              </button>
              <button
                onClick={() => setActiveTab('preview')}
                className={`flex-1 py-3 text-sm font-medium transition ${
                  activeTab === 'preview'
                    ? 'text-green-400 border-t-2 border-green-400 bg-gray-900'
                    : 'text-gray-400 hover:text-gray-300'
                }`}
              >
                <span className="flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </span>
              </button>
            </div>
            )}

            {/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ï¼ˆå³ãƒšãƒ¼ã‚¹ãƒˆâ†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ */}
            {!isFullscreen && activeTab === 'library' && (
            <button
              onClick={() => {
                setCode('');
                setLoadedFile(null);
                handlePaste();
              }}
              className="fixed bottom-20 right-6 w-14 h-14 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-lg flex items-center justify-center transition active:scale-95 z-50"
              title="ãƒšãƒ¼ã‚¹ãƒˆã—ã¦è¿½åŠ "
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
              </svg>
            </button>
            )}

            {/* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é¢¨ï¼‰ */}
            {confirmDialog.show && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]">
                <div className="bg-white rounded-lg shadow-xl mx-4 max-w-sm w-full overflow-hidden">
                  <div className="px-4 py-3 text-gray-900 text-sm text-center">
                    {confirmDialog.message}
                  </div>
                  <div className="flex border-t border-gray-200">
                    <button
                      onClick={() => setConfirmDialog({ show: false, message: '', onConfirm: null })}
                      className="flex-1 py-3 text-blue-600 font-medium text-base border-r border-gray-200 active:bg-gray-100"
                    >
                      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button
                      onClick={confirmDialog.onConfirm}
                      className="flex-1 py-3 text-blue-600 font-medium text-base active:bg-gray-100"
                    >
                      OK
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é¢¨ï¼‰ */}
            {confirmDialog.show && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]">
                <div className="bg-white rounded-lg shadow-xl mx-4 max-w-sm w-full overflow-hidden">
                  <div className="px-4 py-3 text-gray-900 text-sm text-center">
                    {confirmDialog.message}
                  </div>
                  <div className="flex border-t border-gray-200">
                    <button
                      onClick={() => setConfirmDialog({ show: false, message: '', onConfirm: null })}
                      className="flex-1 py-3 text-blue-600 font-medium text-base border-r border-gray-200 active:bg-gray-100"
                    >
                      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button
                      onClick={confirmDialog.onConfirm}
                      className="flex-1 py-3 text-blue-600 font-medium text-base active:bg-gray-100"
                    >
                      OK
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {syncModal.show && (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[300]" onClick={closeSyncModal}>
                <div className="bg-gray-900 rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                  {syncModal.mode === 'generate' ? (
                    <>
                      <div className="p-6 text-center">
                        <h3 className="text-white font-bold text-lg mb-2">åŒæœŸã‚³ãƒ¼ãƒ‰</h3>
                        <p className="text-gray-400 text-sm mb-4">{syncModal.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</p>
                        {syncModal.loading ? (
                          <div className="py-8">
                            <div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                            <p className="text-gray-400 text-sm mt-4">ã‚³ãƒ¼ãƒ‰ç™ºè¡Œä¸­...</p>
                          </div>
                        ) : syncModal.error ? (
                          <div className="py-8">
                            <p className="text-red-400">{syncModal.error}</p>
                          </div>
                        ) : (
                          <>
                            <div className="bg-gray-800 rounded-lg py-6 px-4">
                              <p className="text-5xl font-mono font-bold text-white tracking-[0.3em]">{syncModal.code}</p>
                            </div>
                            <p className="text-gray-500 text-xs mt-4">1åˆ†é–“æœ‰åŠ¹ãƒ»1å›é™ã‚Š</p>
                          </>
                        )}
                      </div>
                      <div className="border-t border-gray-700">
                        <button
                          onClick={closeSyncModal}
                          className="w-full py-4 text-blue-400 font-medium text-base active:bg-gray-800"
                        >
                          é–‰ã˜ã‚‹
                        </button>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="p-6 text-center">
                        <h3 className="text-white font-bold text-lg mb-2">åŒæœŸã‚³ãƒ¼ãƒ‰å…¥åŠ›</h3>
                        <p className="text-gray-400 text-sm mb-4">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                        <input
                          type="text"
                          inputMode="numeric"
                          pattern="[0-9]*"
                          maxLength={4}
                          value={syncCodeInput}
                          onChange={(e) => setSyncCodeInput(e.target.value.replace(/\D/g, '').slice(0, 4))}
                          className="w-full text-center text-4xl font-mono font-bold tracking-[0.3em] bg-gray-800 text-white rounded-lg py-4 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          placeholder="0000"
                          autoFocus
                        />
                        {syncModal.error && (
                          <p className="text-red-400 text-sm mt-3">{syncModal.error}</p>
                        )}
                      </div>
                      <div className="border-t border-gray-700 flex">
                        <button
                          onClick={closeSyncModal}
                          className="flex-1 py-4 text-gray-400 font-medium text-base active:bg-gray-800 border-r border-gray-700"
                        >
                          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button
                          onClick={fetchSyncData}
                          disabled={syncModal.loading || syncCodeInput.length !== 4}
                          className={`flex-1 py-4 font-medium text-base active:bg-gray-800 ${syncModal.loading || syncCodeInput.length !== 4 ? 'text-gray-600' : 'text-blue-400'}`}
                        >
                          {syncModal.loading ? 'å–å¾—ä¸­...' : 'å–å¾—'}
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰ */}
            {editingItem && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]" onClick={() => setEditingItem(null)}>
                <div className="bg-gray-900 rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                  <div className="p-4">
                    <h3 className="text-white font-bold text-base mb-3">ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´</h3>
                    <input
                      type="text"
                      value={editingItem.title}
                      onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          updateTitle(editingItem.id, editingItem.title);
                        } else if (e.key === 'Escape') {
                          setEditingItem(null);
                        }
                      }}
                      className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500"
                      autoFocus
                    />
                  </div>
                  <div className="flex border-t border-gray-700">
                    <button
                      onClick={() => setEditingItem(null)}
                      className="flex-1 py-3 text-gray-400 font-medium text-base border-r border-gray-700 active:bg-gray-800"
                    >
                      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button
                      onClick={() => updateTitle(editingItem.id, editingItem.title)}
                      className="flex-1 py-3 text-blue-400 font-medium text-base active:bg-gray-800"
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰- ä¸Šéƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‹ä¸‹éƒ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
            {actionMenu && (
              <div className="fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-[200] p-4" onClick={() => setActionMenu(null)}>
                {/* ä¸Šéƒ¨ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
                <div className="bg-gray-900 rounded-xl w-full max-w-sm overflow-hidden shadow-2xl mb-3" onClick={e => e.stopPropagation()}>
                  <div className="p-3 border-b border-gray-700">
                    <p className="text-white font-medium text-sm truncate">{actionMenu.title}</p>
                  </div>
                  <div className="grid grid-cols-5 gap-1 p-2">
                    <button
                      onClick={() => { handleLoad(actionMenu); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg active:bg-gray-700 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                      </svg>
                      <span className="text-gray-300 text-xs">é–‹ã</span>
                    </button>
                    <button
                      onClick={async () => {
                        try {
                          await navigator.clipboard.writeText(actionMenu.code);
                          if (navigator.vibrate) navigator.vibrate(30);
                          setActionMenu(null);
                        } catch (e) {
                          alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                      }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg active:bg-gray-700 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                      </svg>
                      <span className="text-gray-300 text-xs">ã‚³ãƒ”ãƒ¼</span>
                    </button>
                    <button
                      onClick={() => { toggleStar(actionMenu.id); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg active:bg-gray-700 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${actionMenu.starred ? 'text-yellow-400' : 'text-gray-400'}`} fill={actionMenu.starred ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                      </svg>
                      <span className="text-gray-300 text-xs">{actionMenu.starred ? 'â˜…è§£é™¤' : 'â˜…'}</span>
                    </button>
                    <button
                      onClick={() => { setEditingItem({ id: actionMenu.id, title: actionMenu.title }); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg active:bg-gray-700 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                      <span className="text-gray-300 text-xs">ç·¨é›†</span>
                    </button>
                    <button
                      onClick={() => { handleDelete(actionMenu.id); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg active:bg-gray-700 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <span className="text-gray-300 text-xs">å‰Šé™¤</span>
                    </button>
                  </div>
                </div>
                {/* ä¸‹éƒ¨ï¼šãƒŸãƒ‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                  <div className="h-72 overflow-hidden">
                    {actionMenu.type === 'SVG' ? (
                      <div
                        className="w-full h-full flex items-center justify-center bg-gray-100 p-2"
                        dangerouslySetInnerHTML={{ __html: actionMenu.code }}
                      />
                    ) : (
                      <iframe
                        srcDoc={actionMenu.code}
                        className="w-full h-full border-0 pointer-events-none"
                        sandbox="allow-scripts"
                        title="preview"
                      />
                    )}
                  </div>
                </div>
                {/* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */}
                <button
                  onClick={() => setActionMenu(null)}
                  className="mt-3 px-6 py-2 bg-gray-800 text-gray-300 rounded-full text-sm active:bg-gray-700"
                >
                  é–‰ã˜ã‚‹
                </button>
              </div>
            )}
          </div>
        );
      }

      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ3ã‚«ãƒ©ãƒ åŒæ™‚è¡¨ç¤ºï¼‰
      return (
        <div className="flex flex-col h-screen bg-gray-900">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          {!isFullscreen && (
          <div className="bg-gray-800 px-6 py-3 flex items-center justify-between border-b border-gray-700">
            <div className="flex items-center gap-3">
              <h1 className="text-white font-bold text-lg">HTML / SVG ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</h1>
              <span className={`px-2 py-0.5 text-xs rounded font-medium ${
                currentMode === 'SVG'
                  ? 'bg-purple-600 text-white'
                  : currentMode === 'TEXT'
                  ? 'bg-gray-600 text-white'
                  : 'bg-blue-600 text-white'
              }`}>
                {currentMode}
              </span>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => fileInputRef.current?.click()}
                className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm rounded transition"
              >
                ğŸ“‚ é–‹ã
              </button>
              {code && (
                <button
                  onClick={() => {
                    setConfirmDialog({
                      show: true,
                      message: 'ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ',
                      onConfirm: () => {
                        setCode('');
                        setLoadedFile(null);
                        setConfirmDialog({ show: false, message: '', onConfirm: null });
                      }
                    });
                  }}
                  className="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded transition"
                >
                  ğŸ—‘ ã‚¯ãƒªã‚¢
                </button>
              )}
              <button
                onClick={handleSave}
                className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-sm rounded transition"
              >
                ğŸ“š ç™»éŒ²
              </button>
              {code && (
                <button
                  onClick={handleDownload}
                  className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded transition"
                >
                  â¬‡ DL
                </button>
              )}
              {currentMode === 'SVG' && (
                <button
                  onClick={handleDownloadPng}
                  className="px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white text-sm rounded transition"
                >
                  ğŸ–¼ PNG
                </button>
              )}
              <button
                onClick={handlePrint}
                className="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white text-sm rounded transition"
              >
                ğŸ–¨ å°åˆ·
              </button>
              <button
                onClick={handleShare}
                disabled={isShortening}
                className={`px-4 py-2 ${isShortening ? 'bg-blue-400' : 'bg-blue-600 hover:bg-blue-500'} text-white text-sm rounded transition`}
              >
                {isShortening ? 'å‡¦ç†ä¸­...' : 'ğŸ”— å…±æœ‰'}
              </button>
            </div>
          </div>
          )}

          {/* 3ã‚«ãƒ©ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <div className="flex-1 flex overflow-hidden">
            {/* å·¦: ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ */}
            {!isFullscreen && (
            <div className="w-1/3 flex flex-col border-r border-gray-700">
              <div className="bg-gray-800 px-4 py-2 text-gray-400 text-sm font-medium border-b border-gray-700">
                ã‚³ãƒ¼ãƒ‰
              </div>
              <textarea
                value={code}
                onChange={(e) => setCode(e.target.value)}
                className="flex-1 bg-gray-950 text-green-400 font-mono text-sm p-4 resize-none focus:outline-none"
                placeholder="ã“ã“ã«HTMLã¾ãŸã¯SVGã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."
                spellCheck={false}
              />
            </div>
            )}

            {/* ä¸­å¤®: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
            <div className={`${isFullscreen ? 'w-full h-full' : 'w-1/3'} flex flex-col ${isFullscreen ? '' : 'border-r border-gray-700'} relative`}>
              {!isFullscreen && (
              <div className="bg-gray-800 px-4 py-2 text-gray-400 text-sm font-medium border-b border-gray-700 flex items-center justify-between">
                <span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                <button
                  onClick={() => setIsFullscreen(true)}
                  className="p-1 hover:bg-gray-700 rounded transition"
                  title="æœ€å¤§åŒ–"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                  </svg>
                </button>
              </div>
              )}
              <div className="flex-1 overflow-hidden">
                {currentMode === 'SVG' ? (
                  <div
                    className="w-full h-full bg-gray-100 overflow-auto p-4"
                    style={{ userSelect: 'text', WebkitUserSelect: 'text' }}
                    dangerouslySetInnerHTML={{ __html: extractSvgTag(debouncedCode.trim()) }}
                  />
                ) : currentMode === 'TEXT' ? (
                  <div className="w-full h-full bg-white overflow-auto p-4">
                    <pre className="whitespace-pre-wrap break-words font-sans text-gray-800 text-base leading-relaxed" style={{ userSelect: 'text', WebkitUserSelect: 'text' }}>{debouncedCode}</pre>
                  </div>
                ) : (
                  <iframe
                    srcDoc={previewCode}
                    title="Preview"
                    className="w-full h-full border-0 bg-white"
                    sandbox="allow-scripts"
                  />
                )}
              </div>
              {/* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤ãƒœã‚¿ãƒ³ */}
              {isFullscreen && (
                <button
                  onClick={() => setIsFullscreen(false)}
                  className="absolute top-4 right-4 p-2 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg shadow-lg transition z-50"
                  title="å…ƒã«æˆ»ã™ (ESC)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
            </div>

            {/* å³: ãƒ©ã‚¤ãƒ–ãƒ©ãƒª */}
            {!isFullscreen && (
            <div className="w-1/3 flex flex-col">
              <div className="bg-gray-800 px-4 py-2 text-gray-400 text-sm font-medium border-b border-gray-700">
                ãƒ©ã‚¤ãƒ–ãƒ©ãƒª {savedItems.length > 0 && `(${savedItems.length})`}
              </div>
              {/* æ¤œç´¢ãƒãƒ¼ */}
              <div className="bg-gray-900 px-3 py-2 border-b border-gray-700">
                <div className="flex items-center gap-2">
                  <div className="relative flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="æ¤œç´¢..."
                      className="w-full pl-9 pr-8 py-1.5 bg-gray-800 border border-gray-700 rounded text-white text-sm placeholder-gray-500 focus:outline-none focus:border-yellow-500"
                    />
                    {searchQuery && (
                      <button
                        onClick={() => setSearchQuery('')}
                        className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                  {/* â˜…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */}
                  <button
                    onClick={() => setShowStarredOnly(!showStarredOnly)}
                    className={`p-1.5 rounded border transition flex-shrink-0 ${
                      showStarredOnly
                        ? 'bg-yellow-500/20 border-yellow-500 text-yellow-400'
                        : 'bg-gray-800 border-gray-700 text-gray-500 hover:text-yellow-400'
                    }`}
                    title={showStarredOnly ? 'å…¨ã¦è¡¨ç¤º' : 'â˜…ã®ã¿è¡¨ç¤º'}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill={showStarredOnly ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                  </button>
                </div>
              </div>
              {/* åŒæœŸãƒœã‚¿ãƒ³ */}
              <div className="bg-gray-900 px-3 py-2 border-b border-gray-700 flex gap-2">
                <button
                  onClick={openSyncInput}
                  className="flex-1 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded transition flex items-center justify-center gap-1"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                  </svg>
                  å—ä¿¡
                </button>
                <button
                  onClick={generateSyncCode}
                  className="flex-1 py-1.5 bg-green-600 hover:bg-green-500 text-white text-xs rounded transition flex items-center justify-center gap-1"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                  </svg>
                  é€ä¿¡
                </button>
              </div>
              {/* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ */}
              <div className="bg-gray-900 px-3 py-2 border-b border-gray-700 flex gap-2 flex-wrap">
                <input
                  ref={importInputRef}
                  type="file"
                  accept=".json"
                  onChange={handleImport}
                  className="hidden"
                />
                <button
                  onClick={() => importInputRef.current?.click()}
                  className="py-1 px-3 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded transition"
                >
                  ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
                <button
                  onClick={toggleSelectAll}
                  disabled={savedItems.length === 0}
                  className={`py-1 px-3 text-white text-xs rounded transition ${savedItems.length === 0 ? 'bg-gray-600 opacity-50' : 'bg-slate-600 hover:bg-slate-500'}`}
                >
                  {selectedItems.size === savedItems.length && savedItems.length > 0 ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ'}
                </button>
                <button
                  onClick={handleExport}
                  disabled={selectedItems.size === 0}
                  className={`py-1 px-3 text-white text-xs rounded transition ${selectedItems.size === 0 ? 'bg-gray-600 opacity-50' : 'bg-green-600 hover:bg-green-500'}`}
                >
                  {selectedItems.size > 0 ? `ä¿å­˜(${selectedItems.size})` : 'ä¿å­˜'}
                </button>
              </div>
              {/* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */}
              <div className="flex-1 overflow-auto bg-gray-950 p-2">
                {savedItems.length === 0 ? (
                  <div className="text-gray-500 text-center py-8 text-sm">
                    <p>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                  </div>
                ) : (() => {
                  const filteredItems = savedItems.filter(item => {
                    if (showStarredOnly && !item.starred) return false;
                    if (!searchQuery.trim()) return true;
                    const query = searchQuery.toLowerCase();
                    return item.title.toLowerCase().includes(query) ||
                           item.code.toLowerCase().includes(query) ||
                           item.type.toLowerCase().includes(query);
                  });
                  return filteredItems.length === 0 ? (
                    <div className="text-gray-500 text-center py-8 text-sm">
                      <p>{showStarredOnly ? 'â˜…ä»˜ãã®é …ç›®ãªã—' : `ã€Œ${searchQuery}ã€ã«ä¸€è‡´ã™ã‚‹é …ç›®ãªã—`}</p>
                    </div>
                  ) : (
                    <div className="space-y-1">
                      {filteredItems.map(item => (
                        <div
                          key={item.id}
                          className={`bg-gray-800 rounded p-2 flex items-center gap-2 hover:bg-gray-700 cursor-pointer transition text-sm ${selectedItems.has(item.id) ? 'ring-2 ring-blue-500' : ''}`}
                        >
                          <div
                            className={`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 cursor-pointer ${selectedItems.has(item.id) ? 'bg-blue-500 border-blue-500' : 'border-gray-500'}`}
                            onClick={() => toggleSelectItem(item.id)}
                          >
                            {selectedItems.has(item.id) && (
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                          </div>
                          {item.starred && (
                            <span className="text-yellow-400 flex-shrink-0 text-sm">â˜…</span>
                          )}
                          <span
                            className="text-white flex-1 truncate"
                            onClick={() => handleLoad(item)}
                          >
                            {item.title}
                          </span>
                          <button
                            onClick={(e) => { e.stopPropagation(); setActionMenu(item); }}
                            className="p-1 text-gray-400 hover:text-white transition flex-shrink-0"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="5" r="2"/>
                              <circle cx="12" cy="12" r="2"/>
                              <circle cx="12" cy="19" r="2"/>
                            </svg>
                          </button>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
            )}
          </div>

          {/* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
          {confirmDialog.show && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]">
              <div className="bg-white rounded-lg shadow-xl mx-4 max-w-sm w-full overflow-hidden">
                <div className="px-4 py-3 text-gray-900 text-sm text-center">
                  {confirmDialog.message}
                </div>
                <div className="flex border-t border-gray-200">
                  <button
                    onClick={() => setConfirmDialog({ show: false, message: '', onConfirm: null })}
                    className="flex-1 py-3 text-blue-600 font-medium text-base border-r border-gray-200 active:bg-gray-100"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={confirmDialog.onConfirm}
                    className="flex-1 py-3 text-blue-600 font-medium text-base active:bg-gray-100"
                  >
                    OK
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {editingItem && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]" onClick={() => setEditingItem(null)}>
              <div className="bg-gray-900 rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="p-4">
                  <h3 className="text-white font-bold text-base mb-3">ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´</h3>
                  <input
                    type="text"
                    value={editingItem.title}
                    onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        updateTitle(editingItem.id, editingItem.title);
                      } else if (e.key === 'Escape') {
                        setEditingItem(null);
                      }
                    }}
                    className="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500"
                    autoFocus
                  />
                </div>
                <div className="flex border-t border-gray-700">
                  <button
                    onClick={() => setEditingItem(null)}
                    className="flex-1 py-3 text-gray-400 font-medium text-base border-r border-gray-700 active:bg-gray-800"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={() => updateTitle(editingItem.id, editingItem.title)}
                    className="flex-1 py-3 text-blue-400 font-medium text-base active:bg-gray-800"
                  >
                    ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
          {actionMenu && (
            <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-[200]" onClick={() => setActionMenu(null)}>
              <div className="bg-gray-900 rounded-t-2xl sm:rounded-xl w-full sm:max-w-xs overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="p-3 border-b border-gray-700">
                  <p className="text-white font-medium text-sm truncate">{actionMenu.title}</p>
                </div>
                <div className="py-1">
                  <button
                    onClick={() => { handleLoad(actionMenu); setActionMenu(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-gray-800 active:bg-gray-700 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span className="text-white">èª­ã¿è¾¼ã¿</span>
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        await navigator.clipboard.writeText(actionMenu.code);
                        if (navigator.vibrate) navigator.vibrate(30);
                        setActionMenu(null);
                      } catch (e) {
                        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                      }
                    }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-gray-800 active:bg-gray-700 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    <span className="text-white">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</span>
                  </button>
                  <button
                    onClick={() => { toggleStar(actionMenu.id); setActionMenu(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-gray-800 active:bg-gray-700 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ${actionMenu.starred ? 'text-yellow-400' : 'text-gray-400'}`} fill={actionMenu.starred ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    <span className="text-white">{actionMenu.starred ? 'â˜…ã‚’å¤–ã™' : 'â˜…ã‚’ã¤ã‘ã‚‹'}</span>
                  </button>
                  <button
                    onClick={() => { setEditingItem({ id: actionMenu.id, title: actionMenu.title }); setActionMenu(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-gray-800 active:bg-gray-700 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span className="text-white">ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†</span>
                  </button>
                  <button
                    onClick={() => { handleDelete(actionMenu.id); setActionMenu(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-gray-800 active:bg-gray-700 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span className="text-white">å‰Šé™¤</span>
                  </button>
                </div>
                <div className="p-2 border-t border-gray-700">
                  <button
                    onClick={() => setActionMenu(null)}
                    className="w-full py-2 text-gray-400 font-medium text-sm active:bg-gray-800 rounded-lg"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {syncModal.show && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[300]" onClick={closeSyncModal}>
              <div className="bg-gray-900 rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                {syncModal.mode === 'generate' ? (
                  <>
                    <div className="p-6 text-center">
                      <h3 className="text-white font-bold text-lg mb-2">åŒæœŸã‚³ãƒ¼ãƒ‰</h3>
                      <p className="text-gray-400 text-sm mb-4">{syncModal.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</p>
                      {syncModal.loading ? (
                        <div className="py-8">
                          <div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                          <p className="text-gray-400 text-sm mt-4">ã‚³ãƒ¼ãƒ‰ç™ºè¡Œä¸­...</p>
                        </div>
                      ) : syncModal.error ? (
                        <div className="py-8">
                          <p className="text-red-400">{syncModal.error}</p>
                        </div>
                      ) : (
                        <>
                          <div className="bg-gray-800 rounded-lg py-6 px-4">
                            <p className="text-5xl font-mono font-bold text-white tracking-[0.3em]">{syncModal.code}</p>
                          </div>
                          <p className="text-gray-500 text-xs mt-4">1åˆ†é–“æœ‰åŠ¹ãƒ»1å›é™ã‚Š</p>
                        </>
                      )}
                    </div>
                    <div className="border-t border-gray-700">
                      <button
                        onClick={closeSyncModal}
                        className="w-full py-4 text-blue-400 font-medium text-base active:bg-gray-800"
                      >
                        é–‰ã˜ã‚‹
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="p-6 text-center">
                      <h3 className="text-white font-bold text-lg mb-2">åŒæœŸã‚³ãƒ¼ãƒ‰å…¥åŠ›</h3>
                      <p className="text-gray-400 text-sm mb-4">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                      <input
                        type="text"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        maxLength={4}
                        value={syncCodeInput}
                        onChange={(e) => setSyncCodeInput(e.target.value.replace(/\D/g, '').slice(0, 4))}
                        className="w-full text-center text-4xl font-mono font-bold tracking-[0.3em] bg-gray-800 text-white rounded-lg py-4 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="0000"
                        autoFocus
                      />
                      {syncModal.error && (
                        <p className="text-red-400 text-sm mt-3">{syncModal.error}</p>
                      )}
                    </div>
                    <div className="border-t border-gray-700 flex">
                      <button
                        onClick={closeSyncModal}
                        className="flex-1 py-4 text-gray-400 font-medium text-base active:bg-gray-800 border-r border-gray-700"
                      >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                      <button
                        onClick={fetchSyncData}
                        disabled={syncModal.loading || syncCodeInput.length !== 4}
                        className={`flex-1 py-4 font-medium text-base active:bg-gray-800 ${syncModal.loading || syncCodeInput.length !== 4 ? 'text-gray-600' : 'text-blue-400'}`}
                      >
                        {syncModal.loading ? 'å–å¾—ä¸­...' : 'å–å¾—'}
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<HTMLPreviewer />);
  </script>
</body>
</html>
