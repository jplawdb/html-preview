<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML / SVG プレビューツール</title>
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Preview">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* テーマ用CSS変数 */
    :root {
      --bg-primary: #111827;
      --bg-secondary: #1F2937;
      --bg-tertiary: #374151;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --accent: #FACC15;
      --border: #374151;
    }
    [data-theme="light"] {
      --bg-primary: #FAF9F6;
      --bg-secondary: #F3F2EF;
      --bg-tertiary: #E8E6E3;
      --text-primary: #1A1A1A;
      --text-secondary: #666666;
      --accent: #DA7756;
      --border: #E5E4E1;
    }
    /* タッチデバイスでのスクロール改善 */
    textarea {
      -webkit-overflow-scrolling: touch;
    }
    /* iOS Safari対応 */
    @supports (-webkit-touch-callout: none) {
      .h-screen {
        height: -webkit-fill-available;
      }
    }
    /* iOS風フローティングボタンのパルスアニメーション */
    @keyframes pulse-soft {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    /* ☰ボタン押下時のぷにっとアニメーション用 */
    .hamburger-pressed {
      transform: scale(1.5) !important;
      background-color: rgba(255, 255, 255, 0.9) !important;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.8) !important;
    }
    /* ボタン押下時のスケールアニメーション */
    .btn-press:active {
      transform: scale(0.95);
      transition: transform 0.1s ease-out;
    }
    /* 選択アイテムのパルスアニメーション */
    @keyframes selection-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
    }
    .item-selected {
      animation: selection-pulse 2s ease-in-out infinite;
    }
    </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useCallback, useEffect, useMemo } = React;

    // URL短縮サービスのエンドポイント（Cloudflare Worker）
    const SHORTENER_URL = 'https://url-shortener.takalovesthailand.workers.dev';
    // 同期サービスのエンドポイント
    const SYNC_URL = 'https://html-preview-sync.takalovesthailand.workers.dev';

    // IndexedDB ヘルパー（localStorage の代替、容量制限なし）
    const DB_NAME = 'html-preview-db';
    const DB_VERSION = 2;
    const STORE_NAME = 'library';

    const openDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    };

    const saveToIndexedDB = async (items) => {
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      // 全削除して再保存（シンプルな実装）
      store.clear();
      items.forEach(item => store.put(item));
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    };

    const loadFromIndexedDB = async () => {
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      return new Promise((resolve, reject) => {
        request.onsuccess = () => {
          db.close();
          // IDで降順ソート（新しい順）
          const items = request.result.sort((a, b) => b.id - a.id);
          resolve(items);
        };
        request.onerror = () => { db.close(); reject(request.error); };
      });
    };

    // localStorage → IndexedDB 移行
    const migrateFromLocalStorage = async () => {
      const MIGRATED_KEY = 'html-preview-migrated-to-idb';
      if (localStorage.getItem(MIGRATED_KEY)) return null; // 移行済み

      const saved = localStorage.getItem('html-preview-library');
      if (saved) {
        try {
          const items = JSON.parse(saved);
          await saveToIndexedDB(items);
          localStorage.setItem(MIGRATED_KEY, '1');
          // 古いデータは残しておく（バックアップとして）
          console.log('Migrated to IndexedDB:', items.length, 'items');
          return items;
        } catch (e) {
          console.error('Migration failed:', e);
        }
      }
      localStorage.setItem(MIGRATED_KEY, '1');
      return null;
    };

    function HTMLPreviewer() {
      const [code, setCode] = useState('');

      const [isPreviewMaximized, setIsPreviewMaximized] = useState(false);
      const [leftPanelWidth, setLeftPanelWidth] = useState(50);
      // デスクトップ3カラム用パネル幅（%）
      const [codePanelWidth, setCodePanelWidth] = useState(() => {
        return parseInt(localStorage.getItem('html-preview-code-width') || '30', 10);
      });
      const [previewPanelWidth, setPreviewPanelWidth] = useState(() => {
        return parseInt(localStorage.getItem('html-preview-preview-width') || '40', 10);
      });
      const [activeTab, setActiveTab] = useState('preview'); // プレビューがメイン画面
      const [sidebarOpen, setSidebarOpen] = useState(false); // サイドバー開閉状態
      const [hamburgerPressed, setHamburgerPressed] = useState(false); // ☰ボタン押下状態
      const [isMobile, setIsMobile] = useState(false);
      const [savedItems, setSavedItems] = useState([]);
      const [showLibrary, setShowLibrary] = useState(false);
      const [debouncedCode, setDebouncedCode] = useState('');
      const [isFullscreen, setIsFullscreen] = useState(false);
      const [loadedFile, setLoadedFile] = useState(null); // { name, type: 'PDF'|'HTML'|'SVG'|'IMAGE' }
      const [searchQuery, setSearchQuery] = useState(''); // ライブラリ検索
      const [showStarredOnly, setShowStarredOnly] = useState(false); // ★のみ表示
      const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null }); // カスタム確認ダイアログ
      const [clearConfirmCount, setClearConfirmCount] = useState(() => {
        return parseInt(localStorage.getItem('html-preview-clear-count') || '0', 10);
      }); // クリア確認カウント（10回で非表示）
      const [showPreviewMenu, setShowPreviewMenu] = useState(false); // プレビューツールバーの三点メニュー
      const [hideUI, setHideUI] = useState(false); // スクロール時にUI非表示
      const [zoomLevel, setZoomLevel] = useState(() => {
        return parseInt(localStorage.getItem('html-preview-zoom') || '100', 10);
      }); // プレビューのズームレベル（%）
      const lastScrollY = React.useRef(0); // 前回のスクロール位置
      const [selectedItems, setSelectedItems] = useState(new Set()); // 選択中のアイテムID
      const [syncModal, setSyncModal] = useState({ show: false, mode: null, code: null, loading: false, error: null }); // 同期モーダル
      const [syncCodeInput, setSyncCodeInput] = useState(''); // 同期コード入力
      const [editingItem, setEditingItem] = useState(null); // 編集中のアイテム { id, title }
      const [actionMenu, setActionMenu] = useState(null); // アクションメニュー用アイテム
      const [contextMenuPos, setContextMenuPos] = useState(null); // 右クリックメニュー位置 { x, y }
      const [toast, setToast] = useState({ show: false, message: '', type: 'default' }); // トースト通知
      const [theme, setTheme] = useState(() => {
        return localStorage.getItem('html-preview-theme') || 'dark';
      }); // テーマ（dark/light）
      const showPasteButton = useMemo(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get('paste') === '1';
      }, []);
      const containerRef = useRef(null);
      const toastTimerRef = useRef(null);
      const isDragging = useRef(false);
      const longPressTimer = useRef(null);
      const textareaRef = useRef(null);
      const fileInputRef = useRef(null);
      const importInputRef = useRef(null);
      const libraryLongPressTimer = useRef(null);
      const libraryLongPressTriggered = useRef(false);
      const libraryTouchStart = useRef({ x: 0, y: 0 });
      // サイドバースワイプ用
      const swipeState = useRef({ startX: 0, startY: 0, isSwiping: false, isLocked: false });
      const EDGE_WIDTH = 30; // 左端30pxからサイドバーを開く

      // デスクトップ用リサイザー状態
      const resizingPanel = useRef(null); // 'code' or 'preview'
      const resizeStartX = useRef(0);
      const resizeStartWidth = useRef(0);

      // リサイザードラッグ開始
      const handleResizeStart = useCallback((panel) => (e) => {
        e.preventDefault();
        resizingPanel.current = panel;
        resizeStartX.current = e.clientX;
        resizeStartWidth.current = panel === 'code' ? codePanelWidth : previewPanelWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      }, [codePanelWidth, previewPanelWidth]);

      // リサイザードラッグ中
      useEffect(() => {
        const handleMouseMove = (e) => {
          if (!resizingPanel.current) return;
          const containerWidth = window.innerWidth;
          const deltaX = e.clientX - resizeStartX.current;
          const deltaPercent = (deltaX / containerWidth) * 100;

          if (resizingPanel.current === 'code') {
            const newWidth = Math.min(Math.max(resizeStartWidth.current + deltaPercent, 15), 50);
            setCodePanelWidth(newWidth);
          } else if (resizingPanel.current === 'preview') {
            const newWidth = Math.min(Math.max(resizeStartWidth.current + deltaPercent, 20), 60);
            setPreviewPanelWidth(newWidth);
          }
        };

        const handleMouseUp = () => {
          if (resizingPanel.current) {
            // 保存
            localStorage.setItem('html-preview-code-width', String(Math.round(codePanelWidth)));
            localStorage.setItem('html-preview-preview-width', String(Math.round(previewPanelWidth)));
            resizingPanel.current = null;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [codePanelWidth, previewPanelWidth]);

      // グローバルキーボードショートカット
      useEffect(() => {
        const handleKeyDown = (e) => {
          // 入力中は無視
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            // Escape以外は無視
            if (e.key !== 'Escape') return;
          }

          const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
          const modKey = isMac ? e.metaKey : e.ctrlKey;

          // Escape: フルスクリーン解除 / モーダル閉じ
          if (e.key === 'Escape') {
            if (isFullscreen) {
              setIsFullscreen(false);
              e.preventDefault();
            }
            return;
          }

          // Ctrl/Cmd + S: 保存（ライブラリに登録）
          if (modKey && e.key === 's') {
            e.preventDefault();
            handleSave();
            return;
          }

          // Ctrl/Cmd + O: ファイルを開く
          if (modKey && e.key === 'o') {
            e.preventDefault();
            fileInputRef.current?.click();
            return;
          }

          // Ctrl/Cmd + Shift + D: ダウンロード
          if (modKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            handleDownload();
            return;
          }

          // Ctrl/Cmd + Shift + T: テーマ切替
          if (modKey && e.shiftKey && e.key === 'T') {
            e.preventDefault();
            setTheme(t => t === 'dark' ? 'light' : 'dark');
            return;
          }

          // F: フルスクリーン切替（単体キー、入力欄以外）
          if (e.key === 'f' && !modKey && !e.shiftKey && !e.altKey) {
            e.preventDefault();
            setIsFullscreen(prev => !prev);
            return;
          }
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [isFullscreen, handleSave, handleDownload]);

      // サイドバースワイプ開始（左端からのスワイプでサイドバーを開く）
      const handleSidebarSwipeStart = useCallback((e) => {
        const touch = e.touches[0];
        const isFromLeftEdge = touch.clientX < EDGE_WIDTH;

        swipeState.current = {
          startX: touch.clientX,
          startY: touch.clientY,
          isSwiping: false,
          isLocked: !isFromLeftEdge && !sidebarOpen // 左端以外からの開始はロック（サイドバー開いている時は例外）
        };
      }, [sidebarOpen]);

      // サイドバースワイプ移動
      const handleSidebarSwipeMove = useCallback((e) => {
        const state = swipeState.current;
        if (state.isLocked) return;

        const touch = e.touches[0];
        const dx = touch.clientX - state.startX;
        const dy = touch.clientY - state.startY;

        // 最初の移動で方向を判定
        if (!state.isSwiping && (Math.abs(dx) > 15 || Math.abs(dy) > 15)) {
          if (Math.abs(dy) > Math.abs(dx)) {
            state.isLocked = true; // 縦スクロール優先
            return;
          }
          state.isSwiping = true;
        }
      }, []);

      // サイドバースワイプ終了
      const handleSidebarSwipeEnd = useCallback((e) => {
        const state = swipeState.current;
        if (!state.isSwiping) return;

        const touch = e.changedTouches[0];
        const dx = touch.clientX - state.startX;
        const threshold = 50; // スワイプ閾値

        if (dx > threshold && !sidebarOpen) {
          // 右スワイプでサイドバーを開く
          setSidebarOpen(true);
          if (navigator.vibrate) navigator.vibrate(10);
        } else if (dx < -threshold && sidebarOpen) {
          // 左スワイプでサイドバーを閉じる
          setSidebarOpen(false);
          if (navigator.vibrate) navigator.vibrate(10);
        }

        swipeState.current = { startX: 0, startY: 0, isSwiping: false, isLocked: false };
      }, [sidebarOpen]);

      // ライブラリ長押し開始
      const handleLibraryTouchStart = useCallback((e, item) => {
        const touch = e.touches[0];
        libraryTouchStart.current = { x: touch.clientX, y: touch.clientY };
        libraryLongPressTriggered.current = false;
        libraryLongPressTimer.current = setTimeout(() => {
          libraryLongPressTriggered.current = true;
          if (navigator.vibrate) navigator.vibrate(50);
          setActionMenu(item);
        }, 500);
      }, []);

      // ライブラリ長押し終了
      const handleLibraryTouchEnd = useCallback(() => {
        if (libraryLongPressTimer.current) {
          clearTimeout(libraryLongPressTimer.current);
          libraryLongPressTimer.current = null;
        }
      }, []);

      // ライブラリタッチ移動（10px以上でキャンセル）
      const handleLibraryTouchMove = useCallback((e) => {
        if (!libraryLongPressTimer.current) return;
        const touch = e.touches[0];
        const dx = touch.clientX - libraryTouchStart.current.x;
        const dy = touch.clientY - libraryTouchStart.current.y;
        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
          clearTimeout(libraryLongPressTimer.current);
          libraryLongPressTimer.current = null;
        }
      }, []);

      // ライブラリアイテムタップ（長押しでなければロード）
      const handleLibraryTap = useCallback((item) => {
        if (libraryLongPressTriggered.current) {
          libraryLongPressTriggered.current = false;
          return;
        }
        handleLoad(item);
      }, []);

      // コードペースト検知→自動プレビュー遷移
      const handleCodePaste = useCallback((e) => {
        // ペースト後、少し待ってからプレビューに遷移
        setTimeout(() => {
          setActiveTab('preview');
          if (navigator.vibrate) navigator.vibrate(10);
        }, 300);
      }, []);

      // ファイル選択ハンドラ（モバイル用）- 画像/HTML/PDF対応
      const handleFileSelect = useCallback((e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        const fileType = file.type;

        // HTMLファイル: テキストとして読み込んで置き換え
        if (fileName.endsWith('.html') || fileName.endsWith('.htm') || fileType === 'text/html') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'HTML' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsText(file);
        }
        // SVGファイル: テキストとして読み込んで置き換え
        else if (fileName.endsWith('.svg') || fileType === 'image/svg+xml') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'SVG' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsText(file);
        }
        // PDFファイル: PDF.jsで画像化
        else if (fileName.endsWith('.pdf') || fileType === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const arrayBuffer = event.target.result;
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

              // メタデータからタイトル取得
              let pdfTitle = file.name;
              try {
                const metadata = await pdf.getMetadata();
                if (metadata?.info?.Title) {
                  pdfTitle = metadata.info.Title;
                }
              } catch (e) {}

              const images = [];
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const scale = 2;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport }).promise;
                const imgData = canvas.toDataURL('image/png');
                images.push(`<img src="${imgData}" alt="Page ${i}" style="max-width:100%;height:auto;margin-bottom:10px;">`);
              }

              setCode(images.join('\n'));
              setLoadedFile({ name: pdfTitle, type: 'PDF' });
              if (navigator.vibrate) navigator.vibrate(50);
            } catch (err) {
              console.error('PDF読み込みエラー:', err);
              showToast('PDFの読み込みに\n失敗しました', 3000, 'error');
            }
          };
          reader.readAsArrayBuffer(file);
        }
        // 画像ファイル: base64でimg挿入
        else if (fileType.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            const imgTag = `<img src="${base64}" alt="${file.name}" style="max-width:100%;height:auto;">`;
            // 既存コードに追加
            setCode(code + (code ? '\n' : '') + imgTag);
            setLoadedFile({ name: file.name, type: 'IMAGE' });
            if (navigator.vibrate) navigator.vibrate(50);
          };
          reader.readAsDataURL(file);
        }

        // 同じファイルを再選択可能にする
        e.target.value = '';
      }, [code]);

      // ドラッグ&ドロップ状態
      const [isDragOver, setIsDragOver] = useState(false);

      // ドラッグ&ドロップハンドラ
      const handleDragOver = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragOver(true);
      }, []);

      const handleDragLeave = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragOver(false);
      }, []);

      const handleDrop = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragOver(false);

        const file = e.dataTransfer.files?.[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        const fileType = file.type;

        // HTMLファイル
        if (fileName.endsWith('.html') || fileName.endsWith('.htm') || fileType === 'text/html') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'HTML' });
          };
          reader.readAsText(file);
        }
        // SVGファイル
        else if (fileName.endsWith('.svg') || fileType === 'image/svg+xml') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'SVG' });
          };
          reader.readAsText(file);
        }
        // 画像ファイル
        else if (fileType.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            const imgTag = `<img src="${base64}" alt="${file.name}" style="max-width:100%;height:auto;">`;
            setCode(code + (code ? '\n' : '') + imgTag);
            setLoadedFile({ name: file.name, type: 'IMAGE' });
          };
          reader.readAsDataURL(file);
        }
        // テキストファイル
        else if (fileType.startsWith('text/') || fileName.endsWith('.txt') || fileName.endsWith('.md')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setCode(event.target.result);
            setLoadedFile({ name: file.name, type: 'TEXT' });
          };
          reader.readAsText(file);
        }
      }, [code]);

      // 長押しでペースト（モバイル用）
      const handleLongPressStart = useCallback((e) => {
        if (!isMobile) return;
        longPressTimer.current = setTimeout(async () => {
          try {
            const text = await navigator.clipboard.readText();
            if (text) {
              setCode(text);
              // 振動フィードバック（対応デバイスのみ）
              if (navigator.vibrate) navigator.vibrate(50);
            }
          } catch (err) {
            console.warn('Clipboard read failed:', err);
          }
        }, 500);
      }, [isMobile]);

      const handleLongPressEnd = useCallback(() => {
        if (longPressTimer.current) {
          clearTimeout(longPressTimer.current);
          longPressTimer.current = null;
        }
      }, []);

      // ペーストボタン用（モバイル）
      const handlePaste = useCallback(async () => {
        // まずClipboard APIを試す
        try {
          const text = await navigator.clipboard.readText();
          if (text) {
            setCode(text);
            if (navigator.vibrate) navigator.vibrate(50);
            // 自動でプレビューに遷移
            setTimeout(() => setActiveTab('preview'), 300);
            return;
          }
        } catch (err) {
          console.warn('Clipboard API failed:', err);
        }

        // フォールバック：テキストエリアにフォーカスしてexecCommandを試す
        if (textareaRef.current) {
          textareaRef.current.focus();
          try {
            const success = document.execCommand('paste');
            if (success) {
              if (navigator.vibrate) navigator.vibrate(50);
              // 自動でプレビューに遷移
              setTimeout(() => setActiveTab('preview'), 300);
              return;
            }
          } catch (e) {
            console.warn('execCommand paste failed:', e);
          }
          // それでもダメなら、フォーカス状態でユーザーに長押しを促す
          // キーボードが開くので、そこから長押しでペースト可能
        }
      }, []);

      // プレビュースクロール時にUI表示/非表示
      const handlePreviewScroll = useCallback((e) => {
        const currentY = e.target.scrollTop;
        const diff = currentY - lastScrollY.current;

        // スクロールしたら三点メニューを閉じる
        if (Math.abs(diff) > 20) {
          setShowPreviewMenu(false);
        }

        // 20px以上スクロールで判定
        if (diff > 20) {
          // 下スクロール → UI非表示
          setHideUI(true);
        } else if (diff < -20) {
          // 上スクロール → UI表示
          setHideUI(false);
        }

        lastScrollY.current = currentY;
      }, []);

      // プレビューエリアタップでUI表示/非表示トグル（iframe用）
      const handlePreviewTap = useCallback((e) => {
        // ダブルタップ的な動作を防ぐため、ボタン等のクリックは除外
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
        setHideUI(prev => !prev);
      }, []);

      const dismissToast = useCallback(() => {
        if (toastTimerRef.current) {
          clearTimeout(toastTimerRef.current);
          toastTimerRef.current = null;
        }
        setToast({ show: false, message: '', type: 'default' });
      }, []);

      const showToast = useCallback((message, duration = 2000, type = 'default') => {
        // iframeフォーカス問題の回避（Chrome iOS）
        if (document.activeElement?.tagName === 'IFRAME') {
          document.activeElement.blur();
        }
        setToast({ show: true, message, type });
        if (toastTimerRef.current) {
          clearTimeout(toastTimerRef.current);
        }
        toastTimerRef.current = setTimeout(() => {
          setToast({ show: false, message: '', type: 'default' });
          toastTimerRef.current = null;
        }, duration);
      }, []);

      // トーストメッセージ内の「登録」「解除」をハイライト
      const renderToastMessage = (message, type) => {
        if (type === 'save' && message.includes('登録')) {
          const parts = message.split('登録');
          return parts.map((part, i) => (
            <React.Fragment key={i}>
              {part.split('\n').map((line, j) => j > 0 ? <React.Fragment key={j}><br/>{line}</React.Fragment> : line)}
              {i < parts.length - 1 && (
                <span style={{ backgroundColor: '#FACC15', color: '#000', fontWeight: 'bold', padding: '0 4px', borderRadius: '4px' }}>登録</span>
              )}
            </React.Fragment>
          ));
        }
        if (type === 'remove' && message.includes('解除')) {
          const parts = message.split('解除');
          return parts.map((part, i) => (
            <React.Fragment key={i}>
              {part.split('\n').map((line, j) => j > 0 ? <React.Fragment key={j}><br/>{line}</React.Fragment> : line)}
              {i < parts.length - 1 && (
                <span style={{ backgroundColor: '#ef4444', color: '#fff', fontWeight: 'bold', padding: '0 4px', borderRadius: '4px' }}>解除</span>
              )}
            </React.Fragment>
          ));
        }
        // error/successタイプは単純にメッセージ表示（背景色はgetToastStyleで制御）
        return message.split('\n').map((line, i) => i > 0 ? <React.Fragment key={i}><br/>{line}</React.Fragment> : line);
      };

      // トーストのスタイルをタイプに応じて変更
      const getToastStyle = (type) => {
        switch (type) {
          case 'error':
            return { backgroundColor: '#dc2626', color: '#fff' };
          case 'success':
            return { backgroundColor: '#16a34a', color: '#fff' };
          default:
            return { backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)' };
        }
      };

      // デバウンス処理（大量テキスト対策）
      useEffect(() => {
        const timer = setTimeout(() => {
          setDebouncedCode(code);
        }, 300);
        return () => clearTimeout(timer);
      }, [code]);

      // テーマ変更時にlocalStorageに保存
      useEffect(() => {
        localStorage.setItem('html-preview-theme', theme);
        document.documentElement.setAttribute('data-theme', theme);
      }, [theme]);

      // 画面サイズ検出
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth < 768);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // タブ切り替え時にUI表示をリセット
      useEffect(() => {
        setHideUI(false);
        lastScrollY.current = 0;
      }, [activeTab]);

      // アンマウント時にトーストタイマーをクリア
      useEffect(() => {
        return () => {
          if (toastTimerRef.current) {
            clearTimeout(toastTimerRef.current);
            toastTimerRef.current = null;
          }
        };
      }, []);

      // iframe内スクロールのpostMessageリスナー
      useEffect(() => {
        let lastProcessed = 0;
        const handleMessage = (e) => {
          if (e.data && e.data.type === 'iframe-scroll') {
            const now = Date.now();
            if (now - lastProcessed < 100) return;
            lastProcessed = now;
            const currentY = e.data.top || 0;
            const diff = currentY - lastScrollY.current;
            // スクロールしたら三点メニューを閉じる
            if (Math.abs(diff) > 20) {
              setShowPreviewMenu(false);
            }
            if (diff > 20) setHideUI(true);
            else if (diff < -20) setHideUI(false);
            lastScrollY.current = currentY;
          }
        };
        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, []);

      // IndexedDBから読み込み（初回はlocalStorageから移行）
      useEffect(() => {
        const loadData = async () => {
          try {
            // まず移行を試みる（既存ユーザー対応）
            const migrated = await migrateFromLocalStorage();
            if (migrated) {
              setSavedItems(migrated);
              return;
            }
            // IndexedDBから読み込み
            const items = await loadFromIndexedDB();
            setSavedItems(items);
          } catch (e) {
            console.error('Failed to load from IndexedDB:', e);
            // フォールバック: localStorageから読み込み
            try {
              const saved = localStorage.getItem('html-preview-library');
              if (saved) setSavedItems(JSON.parse(saved));
            } catch (e2) {
              console.error('Fallback also failed:', e2);
            }
          }
        };
        loadData();
      }, []);

      // URLパラメータからコードを読み込み（フラグメント#を使用）
      useEffect(() => {
        try {
          const hash = window.location.hash;
          if (hash && hash.startsWith('#data=')) {
            const data = hash.slice(6); // '#data=' を除去
            // lz-stringで解凍
            const decoded = LZString.decompressFromEncodedURIComponent(data);
            if (decoded) {
              setCode(decoded);
              setActiveTab('preview');
            }
            // URLをクリーンにする（履歴を残さず）
            window.history.replaceState({}, '', window.location.pathname);
          }
        } catch (e) {
          console.error('Failed to load from URL:', e);
        }
      }, []);

      // ズームレベルをlocalStorageに永続化
      useEffect(() => {
        localStorage.setItem('html-preview-zoom', String(zoomLevel));
      }, [zoomLevel]);

      // SVGタグを抽出（前後のテキストを無視）
      const extractSvgTag = (text) => {
        const startMatch = text.match(/<svg[\s>]/i);
        if (!startMatch) return text;
        const startIndex = text.indexOf(startMatch[0]);
        const tail = text.slice(startIndex);
        const endMatch = tail.match(/<\/svg\s*>/i);
        if (!endMatch) return tail;
        const endIndex = startIndex + endMatch.index + endMatch[0].length;
        return text.slice(startIndex, endIndex);
      };

      const findFirstHtmlTagIndex = (text) => {
        const match = text.match(/<([a-zA-Z][\w:-]*)(\s[^>]*)?>/);
        return match ? text.indexOf(match[0]) : -1;
      };

      // HTML断片を抽出（前後の会話文を無視）
      const extractHtmlFragment = (text) => {
        const startIndex = findFirstHtmlTagIndex(text);
        if (startIndex === -1) return null;
        const tail = text.slice(startIndex);
        const lastClose = tail.toLowerCase().lastIndexOf('</');
        if (lastClose !== -1) {
          const closeEnd = tail.indexOf('>', lastClose);
          if (closeEnd !== -1) return tail.slice(0, closeEnd + 1);
        }
        return tail;
      };

      // HTMLドキュメントを抽出（前後の会話文を無視）
      const extractHtmlDocument = (text) => {
        // <!DOCTYPE html> または <html を探す
        const doctypeMatch = text.match(/<!DOCTYPE\s+html[^>]*>/i);
        const htmlStartMatch = text.match(/<html[\s>]/i);

        let startIndex = -1;
        if (doctypeMatch) {
          startIndex = text.indexOf(doctypeMatch[0]);
        } else if (htmlStartMatch) {
          startIndex = text.indexOf(htmlStartMatch[0]);
        }

        if (startIndex === -1) return null;

        // </html> を開始位置より後から探す（前文の閉じタグ誤検出を防ぐ）
        const tail = text.slice(startIndex);
        const endMatch = tail.match(/<\/html\s*>/i);
        if (!endMatch) {
          // </html> がなければ末尾まで
          return tail;
        }

        const endIndex = startIndex + endMatch.index + endMatch[0].length;
        return text.slice(startIndex, endIndex);
      };

      // SVGからテキストを抽出（ファイル名用）
      const extractSvgTexts = (svgString) => {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(svgString, 'image/svg+xml');
          const texts = [];
          doc.querySelectorAll('text').forEach(text => {
            const content = text.textContent?.trim();
            if (content) texts.push(content);
          });
          return texts;
        } catch (e) {
          return [];
        }
      };

      // 登録機能
      const handleSave = useCallback(() => {
        if (!code.trim()) return;

        const trimmed = code.trim();
        // HTMLドキュメントが含まれているかチェック（前後のテキストを無視）
        const hasHtmlDoc = /<!DOCTYPE\s+html/i.test(trimmed) || /<html[\s>]/i.test(trimmed);
        // SVGが含まれているかチェック（前後のテキストを無視）
        const hasSvg = /<svg[\s>]/i.test(trimmed);
        const isSvg = hasSvg && !hasHtmlDoc;
        const hasHtmlTag = /<([a-zA-Z][\w:-]*)(\s[^>]*)?>/.test(trimmed);
        // loadedFileがあればそのタイプを優先
        const type = loadedFile?.type || (hasHtmlDoc ? 'HTML' : isSvg ? 'SVG' : hasHtmlTag ? 'HTML' : 'TEXT');
        const content = isSvg ? extractSvgTag(trimmed) : code;
        let title = '';

        // loadedFileがあればそのタイトルを優先
        if (loadedFile?.name) {
          title = loadedFile.name;
        }
        // タイトル取得（loadedFileがない場合）
        else if (isSvg) {
          // メインタイトルコメントから取得
          const match = content.match(/<!--\s*メインタイトル\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
          if (match && match[1]) {
            title = match[1].trim();
          }
          // なければ最初のテキスト要素
          if (!title) {
            const texts = extractSvgTexts(content);
            if (texts.length > 0) title = texts[0];
          }
        } else if (type === 'HTML') {
          // HTMLの場合は<title>タグから取得
          const titleMatch = code.match(/<title[^>]*>([^<]+)<\/title>/i);
          if (titleMatch && titleMatch[1]) {
            title = titleMatch[1].trim();
          }
        } else if (type === 'TEXT') {
          // テキストの場合は最初の行をタイトルに
          const firstLine = code.trim().split('\n')[0];
          title = firstLine;
        }
        title = title.slice(0, 50).replace(/[\/\\:*?"<>|\n\r]/g, '').trim() || type;

        // 既存アイテムをチェック（コード完全一致）
        const existingIndex = savedItems.findIndex(item => item.code === content);

        if (existingIndex !== -1) {
          // 登録解除
          const updated = savedItems.filter((_, i) => i !== existingIndex);
          setSavedItems(updated);
          saveToIndexedDB(updated).catch(e => console.error('Save error:', e));
          showToast('ライブラリから\n解除しました', 2000, 'remove');
        } else {
          // 新規登録
          const newItem = {
            id: Date.now(),
            title,
            type,
            code: content,
            createdAt: new Date().toISOString()
          };
          const updated = [newItem, ...savedItems];
          setSavedItems(updated);
          saveToIndexedDB(updated).catch(e => console.error('Save error:', e));
          showToast('ライブラリに\n登録しました', 2000, 'save');
        }
      }, [code, savedItems, loadedFile, showToast]);

      // 削除機能
      const handleDelete = useCallback((id) => {
        setConfirmDialog({
          show: true,
          message: '削除しますか？',
          onConfirm: () => {
            const updated = savedItems.filter(item => item.id !== id);
            setSavedItems(updated);
            saveToIndexedDB(updated).catch(e => console.error('Save error:', e));
            setConfirmDialog({ show: false, message: '', onConfirm: null });
          }
        });
      }, [savedItems]);

      // クリア機能（10回確認後は確認なしでクリア）
      const handleClear = useCallback(() => {
        if (!code) return;

        const doClear = () => {
          setCode('');
          setLoadedFile(null);
        };

        // 10回以上確認済みなら確認なしでクリア
        if (clearConfirmCount >= 10) {
          doClear();
          return;
        }

        // 確認ダイアログ表示（カウント付き）
        const remaining = clearConfirmCount + 1;
        setConfirmDialog({
          show: true,
          message: `クリアしますか？ ${remaining}/10`,
          onConfirm: () => {
            doClear();
            const newCount = clearConfirmCount + 1;
            setClearConfirmCount(newCount);
            localStorage.setItem('html-preview-clear-count', String(newCount));
            setConfirmDialog({ show: false, message: '', onConfirm: null });
          }
        });
      }, [code, clearConfirmCount]);

      // スター切り替え
      const toggleStar = useCallback((id) => {
        const updated = savedItems.map(item =>
          item.id === id ? { ...item, starred: !item.starred } : item
        );
        setSavedItems(updated);
        saveToIndexedDB(updated).catch(e => console.error('Save error:', e));
        if (navigator.vibrate) navigator.vibrate(30);
      }, [savedItems]);

      // タイトル変更
      const updateTitle = useCallback((id, newTitle) => {
        if (!newTitle.trim()) return;
        const updated = savedItems.map(item =>
          item.id === id ? { ...item, title: newTitle.trim() } : item
        );
        setSavedItems(updated);
        saveToIndexedDB(updated).catch(e => console.error('Save error:', e));
        setEditingItem(null);
        if (navigator.vibrate) navigator.vibrate(30);
      }, [savedItems]);

      // 読み込み機能
      const handleLoad = useCallback((item) => {
        setCode(item.code);
        setActiveTab('preview');
      }, []);

      // SVGをHTMLでラップする関数
      const wrapSvgInHtml = useCallback((svgCode, title) => {
        return `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title || 'SVG'}</title>
  <style>
    body { margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; background: #f5f5f5; }
    svg { max-width: 100%; max-height: 100vh; width: auto; height: auto; }
  </style>
</head>
<body>
${svgCode}
</body>
</html>`;
      }, []);

      // ファイル名をサニタイズ
      const sanitizeFilename = useCallback((name) => {
        return name.replace(/[<>:"/\\|?*\x00-\x1f]/g, '_').slice(0, 100);
      }, []);

      // エクスポート機能（デスクトップ: HTML ZIP / モバイル: JSON）
      const handleExport = useCallback(async () => {
        const itemsToExport = savedItems.filter(item => selectedItems.has(item.id));
        if (itemsToExport.length === 0) return;

        // デスクトップ: ZIP with individual HTML files
        if (!isMobile) {
          const zip = new JSZip();
          const usedNames = new Set();

          itemsToExport.forEach(item => {
            let content = item.code;
            let baseName = sanitizeFilename(item.title || 'untitled');

            // SVGの場合はHTMLでラップ
            if (item.type === 'svg' || (content.trim().startsWith('<svg') || content.trim().startsWith('<?xml'))) {
              content = wrapSvgInHtml(content, item.title);
            }

            // 重複ファイル名を回避
            let fileName = `${baseName}.html`;
            let counter = 1;
            while (usedNames.has(fileName)) {
              fileName = `${baseName}_${counter}.html`;
              counter++;
            }
            usedNames.add(fileName);

            zip.file(fileName, content);
          });

          const blob = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `html-preview-${new Date().toISOString().slice(0,10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          // モバイル: JSON（従来通り）
          const data = JSON.stringify(itemsToExport, null, 2);
          const blob = new Blob([data], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `html-preview-library-${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        // エクスポート後は選択解除
        setSelectedItems(new Set());
      }, [savedItems, selectedItems, isMobile, wrapSvgInHtml, sanitizeFilename]);

      // アイテム選択トグル
      const toggleSelectItem = useCallback((id) => {
        setSelectedItems(prev => {
          const next = new Set(prev);
          if (next.has(id)) {
            next.delete(id);
          } else {
            next.add(id);
          }
          return next;
        });
      }, []);

      // 全選択/全解除（フィルター対応）
      const toggleSelectAll = useCallback(() => {
        // フィルター適用後のアイテム
        const filteredItems = savedItems.filter(item => {
          if (showStarredOnly && !item.starred) return false;
          if (searchQuery) {
            const q = searchQuery.toLowerCase();
            return item.title.toLowerCase().includes(q) ||
                   item.code.toLowerCase().includes(q);
          }
          return true;
        });

        const filteredIds = new Set(filteredItems.map(item => item.id));
        const allFilteredSelected = filteredItems.length > 0 &&
          filteredItems.every(item => selectedItems.has(item.id));

        if (allFilteredSelected) {
          // フィルター内の選択を解除
          setSelectedItems(prev => {
            const next = new Set(prev);
            filteredIds.forEach(id => next.delete(id));
            return next;
          });
        } else {
          // フィルター内を全選択（既存選択に追加）
          setSelectedItems(prev => new Set([...prev, ...filteredIds]));
        }
      }, [savedItems, selectedItems, showStarredOnly, searchQuery]);

      // フィルター後の全選択状態を計算
      const allFilteredSelected = useMemo(() => {
        const filteredItems = savedItems.filter(item => {
          if (showStarredOnly && !item.starred) return false;
          if (searchQuery) {
            const q = searchQuery.toLowerCase();
            return item.title.toLowerCase().includes(q) ||
                   item.code.toLowerCase().includes(q);
          }
          return true;
        });
        return filteredItems.length > 0 &&
          filteredItems.every(item => selectedItems.has(item.id));
      }, [savedItems, selectedItems, showStarredOnly, searchQuery]);

      // インポート機能（JSON読み込み）
      const handleImport = useCallback((e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) {
              showToast('無効なファイル形式です', 3000, 'error');
              return;
            }
            // 既存データとマージ（IDが重複したら上書き）
            const existingIds = new Set(savedItems.map(item => item.id));
            const newItems = imported.filter(item => !existingIds.has(item.id));
            const merged = [...imported.filter(item => existingIds.has(item.id)), ...savedItems.filter(item => !imported.find(i => i.id === item.id)), ...newItems];
            // IDでソート（新しい順）
            merged.sort((a, b) => b.id - a.id);
            setSavedItems(merged);
            saveToIndexedDB(merged).catch(e => console.error('Save error:', e));
            showToast(`インポート完了！\n（${imported.length}件）`, 2000, 'success');
            if (navigator.vibrate) navigator.vibrate(50);
          } catch (err) {
            console.error('Import error:', err);
            showToast('インポートに\n失敗しました', 3000, 'error');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      }, [savedItems]);

      // 同期コード発行（データをサーバーに保存）
      const generateSyncCode = useCallback(async () => {
        const itemsToExport = savedItems.filter(item => selectedItems.has(item.id));
        if (itemsToExport.length === 0) return;

        setSyncModal({ show: true, mode: 'generate', code: null, loading: true, error: null, count: itemsToExport.length });
        setSelectedItems(new Set());

        try {
          const json = JSON.stringify(itemsToExport);
          const response = await fetch(`${SYNC_URL}/sync`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: json
          });
          const result = await response.json();

          if (result.code) {
            setSyncModal(prev => ({ ...prev, loading: false, code: result.code }));
          } else {
            throw new Error(result.error || 'Unknown error');
          }
        } catch (err) {
          console.error('Sync error:', err);
          setSyncModal(prev => ({ ...prev, loading: false, error: 'コード発行に失敗しました' }));
        }
      }, [savedItems, selectedItems]);

      // 現在のコードを送信（プレビュー画面用）
      const sendCurrentCode = useCallback(async () => {
        if (!code) return;

        const currentItem = {
          id: Date.now(),
          title: loadedFile?.name || 'Preview',
          type: currentMode,
          code: code,
          createdAt: new Date().toISOString()
        };

        setSyncModal({ show: true, mode: 'generate', code: null, loading: true, error: null, count: 1 });

        try {
          const json = JSON.stringify([currentItem]);
          const response = await fetch(`${SYNC_URL}/sync`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: json
          });
          const result = await response.json();

          if (result.code) {
            setSyncModal(prev => ({ ...prev, loading: false, code: result.code }));
          } else {
            throw new Error(result.error || 'Unknown error');
          }
        } catch (err) {
          console.error('Sync error:', err);
          setSyncModal(prev => ({ ...prev, loading: false, error: 'コード発行に失敗しました' }));
        }
      }, [code, loadedFile, currentMode]);

      // 同期コード入力モーダルを開く
      const openSyncInput = useCallback(() => {
        setSyncCodeInput('');
        setSyncModal({ show: true, mode: 'input', code: null, loading: false, error: null });
      }, []);

      // 同期コードでデータを取得
      const fetchSyncData = useCallback(async () => {
        if (!/^\d{4}$/.test(syncCodeInput)) {
          setSyncModal(prev => ({ ...prev, error: '4桁の数字を入力してください' }));
          return;
        }

        setSyncModal(prev => ({ ...prev, loading: true, error: null }));

        try {
          const response = await fetch(`${SYNC_URL}/sync/${syncCodeInput}`);
          const result = await response.json();

          if (result.data) {
            const imported = JSON.parse(result.data);
            if (!Array.isArray(imported)) throw new Error('Invalid format');

            // 既存データとマージ
            const existingIds = new Set(savedItems.map(item => item.id));
            const newItems = imported.filter(item => !existingIds.has(item.id));
            const merged = [...imported.filter(item => existingIds.has(item.id)), ...savedItems.filter(item => !imported.find(i => i.id === item.id)), ...newItems];
            merged.sort((a, b) => b.id - a.id);

            // IndexedDBへ保存（容量制限なし）
            setSavedItems(merged);
            await saveToIndexedDB(merged);
            setSyncModal({ show: false, mode: null, code: null, loading: false, error: null });
            showToast(`インポート完了！\n（${imported.length}件）`, 2000, 'success');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          } else {
            throw new Error(result.error || 'コードが見つかりません');
          }
        } catch (err) {
          console.error('Sync fetch error:', err);
          setSyncModal(prev => ({ ...prev, loading: false, error: err.message || 'データ取得に失敗しました' }));
        }
      }, [syncCodeInput, savedItems]);

      // 同期モーダルを閉じる
      const closeSyncModal = useCallback(() => {
        setSyncModal({ show: false, mode: null, code: null, loading: false, error: null });
        setSyncCodeInput('');
      }, []);

      // URL共有機能（フラグメント#を使用 - より長いデータに対応）
      const [isShortening, setIsShortening] = useState(false);

      const handleShare = useCallback(async () => {
        if (!code.trim()) return;

        try {
          const isSvg = code.includes('<svg');
          const content = isSvg ? extractSvgTag(code.trim()) : code;
          // lz-stringで圧縮（URL安全）
          const compressed = LZString.compressToEncodedURIComponent(content);
          let shareUrl = `${window.location.origin}${window.location.pathname}#data=${compressed}`;

          // 短縮URLサービスが設定されていれば使用
          if (SHORTENER_URL) {
            setIsShortening(true);
            try {
              const response = await fetch(`${SHORTENER_URL}?url=${encodeURIComponent(shareUrl)}`);
              const data = await response.json();
              if (data.shortUrl) {
                shareUrl = data.shortUrl;
              }
            } catch (e) {
              console.warn('URL shortening failed, using original URL:', e);
            } finally {
              setIsShortening(false);
            }
          }

          // 共有処理（Web Share API → クリップボード → prompt）
          const sizeInfo = shareUrl.length < 100 ? '短縮済み' : `${Math.round(shareUrl.length/1000)}KB`;

          // モバイルでWeb Share API対応ならネイティブ共有を使用
          if (navigator.share && isMobile) {
            try {
              await navigator.share({
                title: 'HTML/SVG Preview',
                text: 'プレビューを共有',
                url: shareUrl
              });
              return; // 共有シートが開いたら終了
            } catch (shareError) {
              // ユーザーがキャンセルした場合は何もしない
              if (shareError.name === 'AbortError') return;
              console.warn('Web Share API failed:', shareError);
            }
          }

          // デスクトップまたはWeb Share失敗時はクリップボード
          try {
            await navigator.clipboard.writeText(shareUrl);
            showToast(`共有URLをコピーしました！\n（${sizeInfo}）`, 3000, 'success');
          } catch (clipboardError) {
            // クリップボードも失敗した場合、選択可能なテキストで表示
            console.warn('Clipboard API failed:', clipboardError);
            alert(`共有URL（${sizeInfo}）:\n\n${shareUrl}\n\n↑このURLを長押しでコピーしてください`);
          }
        } catch (e) {
          console.error('Failed to create share URL:', e);
          showToast('共有URLの作成に\n失敗しました', 3000, 'error');
        }
      }, [code, isMobile]);

      // プレビュー用コード（前後の会話文を無視してHTML/SVGを抽出）
      const previewCode = useMemo(() => {
        let trimmed = debouncedCode.trim();

        // エスケープされたHTMLを検出してデコード（アプリからのコピペ対応）
        const hasEscapedHtml = /&lt;[a-zA-Z!\/]/.test(trimmed);
        if (hasEscapedHtml) {
          const actualTags = (trimmed.match(/<[a-zA-Z!\/][^>]*>/g) || []).length;
          const escapedTags = (trimmed.match(/&lt;[a-zA-Z!\/]/g) || []).length;
          // エスケープされたタグが実際のタグより多ければデコード
          if (escapedTags > actualTags) {
            trimmed = trimmed
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&quot;/g, '"')
              .replace(/&#39;/g, "'")
              .replace(/&apos;/g, "'")
              .replace(/&amp;/g, '&');  // &amp;は最後（他のエンティティに影響しないよう）
          }
        }

        // スクロール通知用のインラインハンドラ（onscroll属性方式）
        const scrollHandler = "window.parent.postMessage({type:'iframe-scroll',top:document.documentElement.scrollTop||document.body.scrollTop},'*')";

        // スクロール通知用のスクリプト（window/documentレベルで検知、子要素スクロールも対応）
        const scrollScript = `<scr` + `ipt>(function(){var send=function(){window.parent.postMessage({type:'iframe-scroll',top:document.documentElement.scrollTop||document.body.scrollTop||0},'*')};window.addEventListener('scroll',send,true);document.addEventListener('scroll',send,true)})();</scr` + `ipt>`;

        // HTMLドキュメントが含まれているかチェック
        const hasHtmlDoc = /<!DOCTYPE\s+html/i.test(trimmed) || /<html[\s>]/i.test(trimmed);
        // SVGが含まれているかチェック
        const hasSvg = /<svg[\s>]/i.test(trimmed);
        const hasHtmlTag = /<([a-zA-Z][\w:-]*)(\s[^>]*)?>/.test(trimmed);

        // Markdown検出（HTML/SVGでない場合）- #や*が2回以上あればMD
        const checkMarkdown = (text) => {
          // 見出し # が2回以上
          const headings = text.match(/^#{1,6}\s+/gm);
          if (headings && headings.length >= 2) return true;
          // * または ** が2回以上
          const asterisks = text.match(/\*+[^*\n]+\*+/g);
          if (asterisks && asterisks.length >= 2) return true;
          // リスト - が2回以上
          const lists = text.match(/^[\-\*\+]\s+/gm);
          if (lists && lists.length >= 2) return true;
          // コードブロック ```
          if (/```/.test(text)) return true;
          // 見出し1つ + 他の要素の組み合わせ
          const hasHeading = /^#{1,6}\s+/m.test(text);
          const hasList = /^[\-\*\+]\s+/m.test(text);
          const hasBold = /\*\*[^*]+\*\*/.test(text);
          const hasLink = /\[[^\]]+\]\([^)]+\)/.test(text);
          const hasQuote = /^>\s+/m.test(text);
          // 2つ以上のMD要素があればMD
          const count = [hasHeading, hasList, hasBold, hasLink, hasQuote].filter(Boolean).length;
          if (count >= 2) return true;
          return false;
        };

        // Markdownモード
        if (!hasHtmlDoc && !hasSvg && !hasHtmlTag && checkMarkdown(trimmed)) {
          const html = marked.parse(trimmed);
          return `<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      color: #333;
    }
    h1, h2, h3, h4, h5, h6 { margin-top: 1.5em; margin-bottom: 0.5em; }
    h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
    h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
    pre { background: #f4f4f4; padding: 16px; overflow-x: auto; border-radius: 6px; }
    pre code { background: none; padding: 0; }
    blockquote { border-left: 4px solid #ddd; margin: 1em 0; padding-left: 16px; color: #666; }
    ul, ol { padding-left: 2em; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    img { max-width: 100%; }
    hr { border: none; border-top: 1px solid #eee; margin: 2em 0; }
  </style>
</head>
<body onscroll="${scrollHandler}">
${html}
${scrollScript}
</body>
</html>`;
        }

        // TEXTモード（プレーンテキストを読みやすいデザインで表示）
        if (!hasHtmlDoc && !hasSvg && !trimmed.startsWith('<') && !checkMarkdown(trimmed) && trimmed) {
          // HTMLエスケープ
          const escaped = trimmed
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          // URL自動リンク化
          const linked = escaped.replace(
            /(https?:\/\/[^\s<>&]+)/g,
            '<a href="$1" target="_blank" rel="noopener">$1</a>'
          );
          return `<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      line-height: 1.9;
      padding: 24px;
      max-width: 680px;
      margin: 0 auto;
      color: #2c3e50;
      background: #fefefe;
      font-size: 16px;
      letter-spacing: 0.02em;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    a { color: #3498db; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body onscroll="${scrollHandler}">
${linked}
${scrollScript}
</body>
</html>`;
        }

        // SVGモード（HTMLドキュメントがない場合のみ）
        if (hasSvg && !hasHtmlDoc) {
          const svgOnly = extractSvgTag(trimmed);
          return `<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    svg {
      max-width: 100%;
      max-height: 100vh;
      width: auto;
      height: auto;
    }
  </style>
</head>
<body onscroll="${scrollHandler}">
  ${svgOnly}
${scrollScript}
</body>
</html>`;
        }

        // HTMLドキュメントを抽出（前後の会話文を無視）
        let html = hasHtmlDoc
          ? extractHtmlDocument(trimmed) || debouncedCode
          : hasHtmlTag
            ? extractHtmlFragment(trimmed) || debouncedCode
            : debouncedCode;

        // 既存の body タグがある場合は属性を追加
        if (/<body\b/i.test(html)) {
          // onscroll が既にある場合は上書きしない
          if (!/<body[^>]*onscroll/i.test(html)) {
            html = html.replace(/<body\b([^>]*)>/i, `<body$1 onscroll="${scrollHandler}">`);
          }
        } else if (/<html\b/i.test(html)) {
          // html タグはあるが body がない場合
          if (/<\/head>/i.test(html)) {
            html = html.replace(/<\/head>/i, `</head><body onscroll="${scrollHandler}">`);
            html = html.replace(/<\/html>/i, '</body></html>');
          }
        } else {
          // html タグもない場合（断片的なHTML）
          html = `<body onscroll="${scrollHandler}">${html}</body>`;
        }

        // scrollScriptを注入（</body>または</html>の前、なければ末尾）
        if (/<\/body>/i.test(html)) {
          html = html.replace(/<\/body>/i, `${scrollScript}</body>`);
        } else if (/<\/html>/i.test(html)) {
          html = html.replace(/<\/html>/i, `${scrollScript}</html>`);
        } else {
          html = html + scrollScript;
        }

        return html;
      }, [debouncedCode]);

      // Markdown検出関数 - #や*が2回以上あればMD
      const isMarkdown = useCallback((text) => {
        // 見出し # が2回以上
        const headings = text.match(/^#{1,6}\s+/gm);
        if (headings && headings.length >= 2) return true;
        // * または ** が2回以上
        const asterisks = text.match(/\*+[^*\n]+\*+/g);
        if (asterisks && asterisks.length >= 2) return true;
        // リスト - が2回以上
        const lists = text.match(/^[\-\*\+]\s+/gm);
        if (lists && lists.length >= 2) return true;
        // コードブロック ```
        if (/```/.test(text)) return true;
        // 2つ以上のMD要素の組み合わせ
        const hasHeading = /^#{1,6}\s+/m.test(text);
        const hasList = /^[\-\*\+]\s+/m.test(text);
        const hasBold = /\*\*[^*]+\*\*/.test(text);
        const hasLink = /\[[^\]]+\]\([^)]+\)/.test(text);
        const hasQuote = /^>\s+/m.test(text);
        const count = [hasHeading, hasList, hasBold, hasLink, hasQuote].filter(Boolean).length;
        if (count >= 2) return true;
        return false;
      }, []);

      // 現在のコードが既に登録済みかどうか（handleSaveと同じロジックで比較）
      const isAlreadySaved = useMemo(() => {
        if (!code) return false;
        const trimmed = code.trim();
        const hasHtmlDoc = /<!DOCTYPE\s+html/i.test(trimmed) || /<html[\s>]/i.test(trimmed);
        const hasSvg = /<svg[\s>]/i.test(trimmed);
        const isSvg = hasSvg && !hasHtmlDoc;
        const content = isSvg ? extractSvgTag(trimmed) : code;
        return savedItems.some(item => item.code === content);
      }, [savedItems, code]);

      // 現在のモードを判定（コード内のHTML/SVGを検出、前後の会話文を無視）
      const currentMode = useMemo(() => {
        const trimmed = debouncedCode.trim();
        if (!trimmed) return 'HTML';

        // HTMLドキュメントが含まれているかチェック（前後のテキストを無視）
        const hasHtmlDoc = /<!DOCTYPE\s+html/i.test(trimmed) || /<html[\s>]/i.test(trimmed);
        if (hasHtmlDoc) return 'HTML';

        // SVGが含まれているかチェック（前後のテキストを無視）
        const hasSvg = /<svg[\s>]/i.test(trimmed);
        if (hasSvg) return 'SVG';

        // その他のHTMLタグが含まれる
        const hasHtmlTag = /<([a-zA-Z][\w:-]*)(\s[^>]*)?>/.test(trimmed);
        if (hasHtmlTag) return 'HTML';

        // Markdown検出
        if (isMarkdown(trimmed)) return 'MARKDOWN';

        return 'TEXT';
      }, [debouncedCode, isMarkdown]);

      // マウスイベント（デスクトップ用）
      const handleMouseDown = useCallback((e) => {
        isDragging.current = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      }, []);

      const handleMouseMove = useCallback((e) => {
        if (!isDragging.current || !containerRef.current) return;
        const container = containerRef.current;
        const rect = container.getBoundingClientRect();
        const newWidth = ((e.clientX - rect.left) / rect.width) * 100;
        if (newWidth >= 20 && newWidth <= 80) {
          setLeftPanelWidth(newWidth);
        }
      }, []);

      const handleMouseUp = useCallback(() => {
        isDragging.current = false;
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
      }, []);

      // タッチイベント（モバイル/タブレット用）
      const handleTouchStart = useCallback((e) => {
        isDragging.current = true;
      }, []);

      const handleTouchMove = useCallback((e) => {
        if (!isDragging.current || !containerRef.current) return;
        const touch = e.touches[0];
        const container = containerRef.current;
        const rect = container.getBoundingClientRect();
        const newWidth = ((touch.clientX - rect.left) / rect.width) * 100;
        if (newWidth >= 20 && newWidth <= 80) {
          setLeftPanelWidth(newWidth);
        }
      }, []);

      const handleTouchEnd = useCallback(() => {
        isDragging.current = false;
      }, []);

      // PNG変換ダウンロード（SVGのみ）
      const handleDownloadPng = useCallback(async () => {
        if (currentMode !== 'SVG') return;

        try {
          let svgContent = extractSvgTag(code.trim());
          if (!svgContent) return;

          // SVGのサイズを取得
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
          const svgEl = svgDoc.querySelector('svg');

          if (!svgEl) {
            showToast('SVGの解析に\n失敗しました', 3000, 'error');
            return;
          }

          // viewBoxからサイズ取得を試みる
          let width, height;
          const viewBox = svgEl.getAttribute('viewBox');
          if (viewBox) {
            const parts = viewBox.split(/\s+|,/).map(Number);
            width = parts[2] || 800;
            height = parts[3] || 600;
          } else {
            width = parseInt(svgEl.getAttribute('width')) || 800;
            height = parseInt(svgEl.getAttribute('height')) || 600;
          }

          // SVGにwidth/height属性を確実に設定（モバイル対応）
          svgEl.setAttribute('width', width);
          svgEl.setAttribute('height', height);
          svgContent = new XMLSerializer().serializeToString(svgEl);

          // 高解像度対応（2倍）
          const scale = 2;

          // Canvasを作成
          const canvas = document.createElement('canvas');
          canvas.width = width * scale;
          canvas.height = height * scale;
          const ctx = canvas.getContext('2d');
          ctx.scale(scale, scale);

          // 背景を白に
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, width, height);

          // SVGをdata URLに変換（モバイル対応）
          const svgBase64 = btoa(unescape(encodeURIComponent(svgContent)));
          const dataUrl = `data:image/svg+xml;base64,${svgBase64}`;

          // SVGをImageとして読み込み
          const img = new Image();

          img.onload = () => {
            ctx.drawImage(img, 0, 0, width, height);

            // PNGとしてダウンロード
            const pngUrl = canvas.toDataURL('image/png');

            // ファイル名生成
            const now = new Date();
            const timestamp = now.getFullYear().toString() +
              String(now.getMonth() + 1).padStart(2, '0') +
              String(now.getDate()).padStart(2, '0');

            let title = '';
            const match = code.match(/<!--\s*メインタイトル\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
            if (match && match[1]) {
              title = match[1].trim();
            }
            if (!title) {
              const texts = extractSvgTexts(code.trim());
              if (texts.length > 0) title = texts[0];
            }
            title = title.slice(0, 30).replace(/[\/\\:*?"<>|\n\r]/g, '').trim() || 'svg';

            // PWAスタンドアロンモード検出
            const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone === true;

            // モバイルまたはPWAではモーダル表示（長押し/右クリック保存用）
            if (isMobile || isPWA) {
              const modal = document.createElement('div');
              modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
              modal.innerHTML = `
                <p style="color:white;font-size:16px;margin-bottom:16px;text-align:center;">${isMobile ? '📱 画像を長押しして保存' : '🖱️ 画像を右クリックして保存'}</p>
                <img src="${pngUrl}" style="max-width:90%;max-height:70vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);" />
                <button style="margin-top:20px;padding:12px 32px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:16px;">閉じる</button>
              `;
              modal.querySelector('button').onclick = () => modal.remove();
              modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
              document.body.appendChild(modal);
            } else {
              const a = document.createElement('a');
              a.href = pngUrl;
              a.download = `${timestamp}_${title}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          };

          img.onerror = (e) => {
            console.error('Image load error:', e);
            showToast('PNG変換に失敗しました\n（画像読み込みエラー）', 3000, 'error');
          };

          img.src = dataUrl;
        } catch (e) {
          console.error('PNG conversion failed:', e);
          showToast('PNG変換に失敗しました', 3000, 'error');
        }
      }, [code, currentMode]);

      const handleDownload = useCallback(async () => {
        const isSvg = currentMode === 'SVG';
        // UTF-8 BOMを追加して文字化け防止
        const BOM = '\uFEFF';
        // SVGの場合はタグだけ抽出
        const content = isSvg ? extractSvgTag(code.trim()) : code;
        const blob = new Blob([BOM + content], {
          type: isSvg ? 'image/svg+xml;charset=utf-8' : 'text/html;charset=utf-8'
        });

        // タイムスタンプ生成 (YYYYMMDD)
        const now = new Date();
        const timestamp = now.getFullYear().toString() +
          String(now.getMonth() + 1).padStart(2, '0') +
          String(now.getDate()).padStart(2, '0');

        // メインタイトルを取得（<!--メインタイトル-->コメントの直後のテキスト）
        let title = '';
        if (isSvg) {
          try {
            // 正規表現で <!-- メインタイトル --> の直後のテキスト要素を探す（改行・スペース対応）
            const match = code.match(/<!--\s*メインタイトル\s*-->[\s\S]*?<text[^>]*>([^<]+)<\/text>/);
            if (match && match[1]) {
              title = match[1].trim();
            }

            // 見つからなければ最初のテキスト要素
            if (!title) {
              const texts = extractSvgTexts(code.trim());
              if (texts.length > 0) {
                title = texts[0];
              }
            }
          } catch (e) {}
        }
        // ファイル名に使えない文字を除去、最大30文字
        title = title
          .slice(0, 30)
          .replace(/[\/\\:*?"<>|\n\r]/g, '')
          .trim() || (isSvg ? 'svg' : 'html');

        const filename = `${timestamp}_${title}.${isSvg ? 'svg' : 'html'}`;

        // PWAスタンドアロンモード検出
        const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                      window.navigator.standalone === true;

        // PWAモードではWeb Share APIを試す
        if (isPWA && navigator.canShare) {
          try {
            const file = new File([blob], filename, { type: blob.type });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: filename
              });
              return;
            }
          } catch (e) {
            // シェアがキャンセルされた場合は何もしない
            if (e.name === 'AbortError') return;
            // 他のエラーは通常ダウンロードにフォールバック
          }
        }

        // 通常のダウンロード
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, [code, currentMode]);

      // 印刷機能（新しいウィンドウで開いて全ページ印刷可能に）
      const handlePrint = useCallback(() => {
        const isSvg = currentMode === 'SVG';
        const content = isSvg ? extractSvgTag(code.trim()) : code;

        // 印刷用のHTMLを作成（全ページ表示）
        const printHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>印刷プレビュー</title>
  <style>
    @media print {
      body { margin: 0; padding: 20px; }
      @page { margin: 15mm; }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: white;
    }
  </style>
</head>
<body>
${content}
</body>
</html>`;

        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(printHtml);
          printWindow.document.close();
          // 少し待ってから印刷ダイアログを開く
          setTimeout(() => {
            printWindow.print();
          }, 300);
        }
      }, [code, currentMode]);

      // モバイルレイアウト
      if (isMobile) {
        return (
          <>
          <div
            className="flex flex-col h-screen overflow-hidden"
            style={{ backgroundColor: 'var(--bg-primary)' }}
          >
            {/* フローティング☰ボタン（iOS風） */}
            {!isFullscreen && activeTab === 'preview' && (
              <>
                {/* 左上：ライブラリボタン */}
                <button
                  onClick={() => setSidebarOpen(true)}
                  onTouchStart={() => setHamburgerPressed(true)}
                  onTouchEnd={() => setHamburgerPressed(false)}
                  onMouseDown={() => setHamburgerPressed(true)}
                  onMouseUp={() => setHamburgerPressed(false)}
                  onMouseLeave={() => setHamburgerPressed(false)}
                  className={`fixed top-3 left-3 z-20 w-10 h-10 rounded-full
                    backdrop-blur-md shadow-lg
                    flex items-center justify-center
                    ${hamburgerPressed ? 'hamburger-pressed' : ''}`}
                  style={{
                    animation: hamburgerPressed ? undefined : 'pulse-soft 3s ease-in-out infinite',
                    backgroundColor: hamburgerPressed ? 'rgba(255, 255, 255, 0.9)' : 'rgba(107, 114, 128, 0.6)',
                    color: hamburgerPressed ? '#000' : 'rgba(255, 255, 255, 0.8)',
                    transition: 'transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.15s ease-out, box-shadow 0.15s ease-out',
                    transform: hamburgerPressed ? 'scale(1.5)' : 'scale(1)',
                    boxShadow: hamburgerPressed ? '0 0 20px rgba(255, 255, 255, 0.8)' : undefined
                  }}
                  title="ライブラリを開く"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{ filter: 'drop-shadow(0 0 2px white) drop-shadow(0 0 2px white)' }}>
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
                {/* 左下：ファイル添付ボタン（空のプレビュー時のみ表示） */}
                {!code && (
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className={`fixed bottom-16 left-3 z-20 w-10 h-10 rounded-full
                      backdrop-blur-md shadow-lg
                      flex items-center justify-center
                      active:scale-90 transition-all duration-300
                      ${hideUI ? 'opacity-0 pointer-events-none translate-y-4' : 'opacity-100 translate-y-0'}`}
                    style={{
                      backgroundColor: 'rgba(107, 114, 128, 0.6)',
                      color: 'rgba(255, 255, 255, 0.8)'
                    }}
                    title="ファイルを開く"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{ filter: 'drop-shadow(0 0 2px white) drop-shadow(0 0 2px white)' }}>
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                    </svg>
                  </button>
                )}
                {/* 右下：新規入力/ペーストボタン（UI非表示時は隠れる） */}
                <button
                  onClick={code ? handleClear : handlePaste}
                  className={`fixed bottom-16 right-3 z-20 w-10 h-10 rounded-full
                    backdrop-blur-md shadow-lg
                    flex items-center justify-center
                    active:scale-90 transition-all duration-300
                    ${hideUI ? 'opacity-0 pointer-events-none translate-y-4' : 'opacity-100 translate-y-0'}`}
                  style={{
                    backgroundColor: 'rgba(107, 114, 128, 0.6)',
                    color: 'rgba(255, 255, 255, 0.8)'
                  }}
                  title={code ? "新規入力" : "ペースト"}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{ filter: 'drop-shadow(0 0 2px white) drop-shadow(0 0 2px white)' }}>
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
              </>
            )}
            {/* hidden file input */}
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*,.html,.htm,.svg,.pdf"
              onChange={handleFileSelect}
              className="hidden"
            />

            {/* サイドバーオーバーレイ */}
            <div className={`fixed inset-0 z-30 transition-opacity duration-300 ${sidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
              {/* 背景オーバーレイ（タップで閉じる） */}
              <div
                className="absolute inset-0 bg-black/50"
                onClick={() => setSidebarOpen(false)}
                onTouchStart={(e) => {
                  swipeState.current = { startX: e.touches[0].clientX, startY: e.touches[0].clientY, isSwiping: false, isLocked: false };
                }}
                onTouchMove={(e) => {
                  const state = swipeState.current;
                  const touch = e.touches[0];
                  const dx = touch.clientX - state.startX;
                  const dy = touch.clientY - state.startY;
                  if (!state.isSwiping && (Math.abs(dx) > 15 || Math.abs(dy) > 15)) {
                    if (Math.abs(dy) > Math.abs(dx)) {
                      state.isLocked = true;
                      return;
                    }
                    state.isSwiping = true;
                  }
                }}
                onTouchEnd={(e) => {
                  const state = swipeState.current;
                  if (!state.isSwiping) return;
                  const dx = e.changedTouches[0].clientX - state.startX;
                  if (dx < -50) {
                    setSidebarOpen(false);
                    if (navigator.vibrate) navigator.vibrate(10);
                  }
                }}
              />
              {/* サイドバー本体 */}
              <div
                className={`absolute top-0 left-0 bottom-0 w-80 max-w-[85vw] flex flex-col overflow-hidden transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}
                style={{ backgroundColor: 'var(--bg-primary)' }}
              >
                {/* サイドバーヘッダー */}
                <div className="flex items-center justify-between px-4 py-3" style={{ backgroundColor: 'var(--bg-secondary)', borderBottom: '1px solid var(--border)' }}>
                  <span className="font-medium" style={{ color: 'var(--text-primary)' }}>
                    ライブラリ
                  </span>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')}
                      className="p-2 hover:opacity-70 transition"
                      style={{ color: 'var(--text-secondary)' }}
                      title={theme === 'dark' ? 'ライトモードに切替' : 'ダークモードに切替'}
                    >
                      {theme === 'dark' ? (
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                      ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                      )}
                    </button>
                    <button
                      onClick={() => setSidebarOpen(false)}
                      className="p-2 hover:opacity-70 transition"
                      style={{ color: 'var(--text-secondary)' }}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
                {/* 検索バー */}
                <div className="px-3 py-2" style={{ borderBottom: '1px solid var(--border)' }}>
                  <div className="flex items-center gap-2">
                    <div className="relative flex-1">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2" style={{ color: 'var(--text-secondary)' }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="検索..."
                        className="w-full pl-9 pr-8 py-1.5 rounded-lg text-sm focus:outline-none"
                        style={{
                          backgroundColor: 'var(--bg-secondary)',
                          border: '1px solid var(--border)',
                          color: 'var(--text-primary)'
                        }}
                      />
                      {searchQuery && (
                        <button
                          onClick={() => setSearchQuery('')}
                          className="absolute right-2 top-1/2 -translate-y-1/2 hover:opacity-70"
                          style={{ color: 'var(--text-secondary)' }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      )}
                    </div>
                    <button
                      onClick={() => setShowStarredOnly(!showStarredOnly)}
                      className="p-1.5 rounded-lg border transition flex-shrink-0"
                      style={{
                        backgroundColor: showStarredOnly ? (theme === 'dark' ? 'rgba(250, 204, 21, 0.2)' : 'rgba(218, 119, 86, 0.2)') : 'var(--bg-secondary)',
                        borderColor: showStarredOnly ? 'var(--accent)' : 'var(--border)',
                        color: showStarredOnly ? 'var(--accent)' : 'var(--text-secondary)'
                      }}
                      title={showStarredOnly ? '全て表示' : '★のみ表示'}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill={showStarredOnly ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                      </svg>
                    </button>
                  </div>
                </div>
                {/* ツールバー */}
                <div className="flex items-center justify-between px-2 py-1.5" style={{ backgroundColor: 'var(--bg-secondary)', borderBottom: '1px solid var(--border)' }}>
                  <div className="flex gap-1">
                    <button
                      onClick={generateSyncCode}
                      disabled={selectedItems.size === 0}
                      className={`px-2 py-1.5 text-xs rounded-lg transition active:scale-95 ${selectedItems.size === 0 ? 'opacity-50' : 'hover:opacity-80 text-white'}`}
                      style={selectedItems.size === 0 ? { backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-secondary)' } : { backgroundColor: '#22c55e' }}
                    >
                      ↑送信
                    </button>
                    <button
                      onClick={toggleSelectAll}
                      disabled={savedItems.length === 0}
                      className={`px-2 py-1.5 text-xs rounded-lg transition active:scale-95 ${savedItems.length === 0 ? 'opacity-50' : 'bg-slate-600 hover:bg-slate-500 text-white'}`}
                      style={savedItems.length === 0 ? { backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-secondary)' } : undefined}
                    >
                      {allFilteredSelected ? '全解除' : '全選択'}
                    </button>
                    <button
                      onClick={() => {
                        if (selectedItems.size > 0) {
                          setConfirmDialog({
                            show: true,
                            message: `${selectedItems.size}件を削除しますか？`,
                            onConfirm: () => {
                              const newItems = savedItems.filter(item => !selectedItems.has(item.id));
                              setSavedItems(newItems);
                              saveToIndexedDB(newItems).catch(e => console.error('Save error:', e));
                              setSelectedItems(new Set());
                              setConfirmDialog({ show: false, message: '', onConfirm: null });
                            }
                          });
                        }
                      }}
                      disabled={selectedItems.size === 0}
                      className={`p-1.5 rounded-lg transition active:scale-95 ${selectedItems.size === 0 ? 'opacity-50' : 'bg-red-600 hover:bg-red-500 text-white'}`}
                      style={selectedItems.size === 0 ? { backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-secondary)' } : undefined}
                      title="選択項目を削除"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>
                  <div className="flex gap-1">
                    <button
                      onClick={openSyncInput}
                      className="px-2 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded-lg transition active:scale-95"
                    >
                      ↓受信
                    </button>
                    <input
                      ref={importInputRef}
                      type="file"
                      accept=".json"
                      onChange={handleImport}
                      className="hidden"
                    />
                    <button
                      onClick={() => importInputRef.current?.click()}
                      className="p-1.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition active:scale-95"
                      title="JSONインポート"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                      </svg>
                    </button>
                  </div>
                </div>
                {/* ライブラリアイテム一覧 */}
                <div className="flex-1 overflow-auto p-3" style={{ WebkitOverflowScrolling: 'touch', overscrollBehavior: 'contain', touchAction: 'pan-y' }}>
                  {(() => {
                    const filtered = savedItems
                      .filter(item => {
                        if (showStarredOnly && !item.starred) return false;
                        if (!searchQuery) return true;
                        const q = searchQuery.toLowerCase();
                        return item.title.toLowerCase().includes(q) ||
                               item.code.toLowerCase().includes(q);
                      })
                      .sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

                    if (filtered.length === 0) {
                      return (
                        <div className="flex flex-col items-center justify-center h-32" style={{ color: 'var(--text-secondary)' }}>
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                          </svg>
                          <p className="text-sm">{searchQuery || showStarredOnly ? '該当なし' : 'ライブラリは空です'}</p>
                        </div>
                      );
                    }

                    return (
                      <div className="space-y-2">
                        {filtered.map((item) => (
                          <div
                            key={item.id}
                            className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition ${
                              selectedItems.has(item.id)
                                ? 'bg-blue-900/50 border border-blue-500'
                                : 'border border-transparent hover:opacity-80'
                            }`}
                            style={{ touchAction: 'pan-y', userSelect: 'none', WebkitUserSelect: 'none', WebkitTouchCallout: 'none', backgroundColor: selectedItems.has(item.id) ? undefined : 'var(--bg-secondary)' }}
                            onContextMenu={(e) => e.preventDefault()}
                            onTouchStart={(e) => handleLibraryTouchStart(e, item)}
                            onTouchEnd={handleLibraryTouchEnd}
                            onTouchMove={handleLibraryTouchMove}
                            onClick={() => {
                              if (!libraryLongPressTriggered.current) {
                                handleLoad(item);
                                setSidebarOpen(false);
                              }
                              libraryLongPressTriggered.current = false;
                            }}
                          >
                            {/* チェックボックス - タップ領域をカード高さに合わせる */}
                            <div
                              className="self-stretch flex items-center px-3 -ml-2 flex-shrink-0"
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedItems(prev => {
                                  const next = new Set(prev);
                                  if (next.has(item.id)) {
                                    next.delete(item.id);
                                  } else {
                                    next.add(item.id);
                                  }
                                  return next;
                                });
                              }}
                            >
                              <div
                                className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                                  selectedItems.has(item.id)
                                    ? 'bg-blue-500 border-blue-500'
                                    : ''
                                }`}
                                style={!selectedItems.has(item.id) ? { borderColor: 'var(--text-secondary)' } : undefined}
                              >
                                {selectedItems.has(item.id) && (
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                  </svg>
                                )}
                              </div>
                            </div>
                            {/* タイトル */}
                            <div className="flex-1 min-w-0">
                              <div className="text-sm truncate" style={{ color: 'var(--text-primary)' }}>{item.title}</div>
                              <div className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                                {new Date(item.updatedAt || item.createdAt).toLocaleDateString('ja-JP')}
                              </div>
                            </div>
                            {/* ★ */}
                            <button
                              className={`flex-shrink-0 ${item.starred ? 'text-yellow-400' : ''}`}
                              style={!item.starred ? { color: 'var(--text-secondary)' } : undefined}
                              onClick={(e) => {
                                e.stopPropagation();
                                const newItems = savedItems.map(i =>
                                  i.id === item.id ? { ...i, starred: !i.starred } : i
                                );
                                setSavedItems(newItems);
                                saveToIndexedDB(newItems).catch(e => console.error('Save error:', e));
                              }}
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill={item.starred ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                              </svg>
                            </button>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>

            {/* コンテンツ（スワイプ対応） */}
            <div
              className="flex-1 overflow-hidden relative"
              style={{
                paddingBottom: 0
              }}
              onTouchStartCapture={handleSidebarSwipeStart}
              onTouchMoveCapture={handleSidebarSwipeMove}
              onTouchEndCapture={handleSidebarSwipeEnd}
            >
              {activeTab === 'code' ? (
                <div className="flex flex-col w-full h-full">
                  {/* コードビューヘッダー */}
                  <div className="flex items-center justify-between px-2 py-1.5" style={{ backgroundColor: 'var(--bg-secondary)', borderBottom: '1px solid var(--border)' }}>
                    <button
                      onClick={() => setActiveTab('preview')}
                      className="flex items-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg transition active:scale-95"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      プレビュー
                    </button>
                    <span className="text-sm" style={{ color: 'var(--text-secondary)' }}>コード編集</span>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition active:scale-95"
                      title="ファイルを開く"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                      </svg>
                    </button>
                  </div>
                  {/* コードエリア */}
                  <div className="relative flex-1">
                    <textarea
                      ref={textareaRef}
                      value={code}
                      onChange={(e) => setCode(e.target.value)}
                      onPaste={handleCodePaste}
                      onTouchStart={handleLongPressStart}
                      onTouchEnd={handleLongPressEnd}
                      onTouchMove={handleLongPressEnd}
                      className="w-full h-full font-mono text-base leading-relaxed p-4 resize-none focus:outline-none selection:bg-blue-600 selection:text-white"
                      style={{ backgroundColor: theme === 'dark' ? '#030712' : 'var(--bg-tertiary)', color: theme === 'dark' ? '#4ade80' : '#166534' }}
                      placeholder="ここにHTMLまたはSVGコードを貼り付け..."
                      spellCheck={false}
                      autoCapitalize="off"
                      autoCorrect="off"
                    />
                  {!code && (
                    <button
                      onClick={handlePaste}
                      className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 p-6 bg-indigo-600/90 hover:bg-indigo-500 text-white rounded-2xl transition active:scale-95 shadow-lg"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                      </svg>
                      <span className="text-sm font-medium">タップでペースト</span>
                    </button>
                  )}
                  </div>
                </div>
              ) : (
                <div className="flex flex-col w-full h-full">
                  {/* プレビューエリア */}
                  <div className="relative flex-1 overflow-hidden">
                    {/* コードがない場合：ペースト誘導表示 */}
                    {!code ? (
                      <div className="w-full h-full flex flex-col items-center justify-center" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)' }}>
                        <button
                          onClick={handlePaste}
                          className="flex flex-col items-center gap-3 p-6 rounded-2xl hover:bg-purple-900/50 border border-purple-500/30 transition active:scale-95"
                          style={{ backgroundColor: theme === 'dark' ? 'rgba(88, 28, 135, 0.3)' : 'rgba(88, 28, 135, 0.15)' }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                          </svg>
                          <span className="text-lg font-medium" style={{ color: theme === 'dark' ? '#d8b4fe' : '#c084fc' }}>タップしてペースト</span>
                        </button>
                        <p className="mt-4 text-sm" style={{ color: 'var(--text-secondary)' }}>HTML/SVGをプレビュー</p>
                      </div>
                    ) : currentMode === 'SVG' ? (
                      <div
                        className="w-full h-full bg-gray-100 overflow-auto p-4"
                        style={{ userSelect: 'text', WebkitUserSelect: 'text' }}
                        onScroll={handlePreviewScroll}
                      >
                        <div style={{ transform: `scale(${zoomLevel * 0.8 / 100})`, transformOrigin: 'top left', width: `${12500 / zoomLevel}%` }} dangerouslySetInnerHTML={{ __html: extractSvgTag(debouncedCode.trim()) }} />
                      </div>
                    ) : currentMode === 'TEXT' ? (
                      <div className="w-full h-full relative overflow-auto">
                        <iframe
                          srcDoc={previewCode}
                          title="Preview"
                          className="border-0 bg-white"
                          sandbox="allow-scripts"
                          style={{ width: `${12500 / zoomLevel}%`, height: `${12500 / zoomLevel}%`, transform: `scale(${zoomLevel * 0.8 / 100})`, transformOrigin: 'top left' }}
                        />
                      </div>
                    ) : (
                      <div className="w-full h-full relative overflow-auto">
                        <iframe
                          srcDoc={previewCode}
                          title="Preview"
                          className="border-0 bg-white"
                          sandbox="allow-scripts"
                          style={{ width: `${12500 / zoomLevel}%`, height: `${12500 / zoomLevel}%`, transform: `scale(${zoomLevel * 0.8 / 100})`, transformOrigin: 'top left' }}
                        />
                        {/* タップオーバーレイ（UI非表示時のみ表示、pointer-events-noneでスクロール通過） */}
                        {hideUI && (
                          <div className="absolute inset-0 pointer-events-none">
                            <div
                              className="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1 bg-black/50 text-white text-xs rounded-full pointer-events-auto cursor-pointer"
                              onClick={handlePreviewTap}
                            >
                              タップでUI表示
                            </div>
                          </div>
                        )}
                        {/* UI表示時：上部タップエリア */}
                        {!hideUI && (
                          <div
                            className="absolute top-0 left-0 right-0 h-12 bg-transparent"
                            onClick={handlePreviewTap}
                          />
                        )}
                      </div>
                    )}
                    {/* フローティング同期ボタン（状態に応じて切り替え）- UI非表示と連動 */}
                    <div className={`absolute top-3 right-3 z-30 transition-opacity duration-300 ${hideUI ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                      {code ? (
                        <button
                          onClick={sendCurrentCode}
                          className="px-3 py-1.5 rounded-lg text-sm font-medium shadow-lg transition active:scale-95"
                          style={{ backgroundColor: '#22c55e', color: '#fff' }}
                        >
                          ↑送信
                        </button>
                      ) : (
                        <button
                          onClick={openSyncInput}
                          className="px-3 py-1.5 rounded-lg text-sm font-medium shadow-lg transition active:scale-95"
                          style={{ backgroundColor: '#6366f1', color: '#fff' }}
                        >
                          ↓受信
                        </button>
                      )}
                    </div>
                  </div>
                  {/* 下部ツールバー（最大化時・スクロール時は非表示） */}
                  {!isFullscreen && (
                    <div className={`fixed bottom-0 left-0 right-0 z-20 flex items-center justify-between px-2 py-1.5 transition-transform duration-300 ${hideUI ? 'translate-y-full' : 'translate-y-0'}`} style={{ backgroundColor: 'var(--bg-secondary)', borderTop: '1px solid var(--border)' }}>
                      <div className="flex gap-1">
                        {/* 登録/解除（一番左） */}
                        <button
                          onClick={handleSave}
                          disabled={!code}
                          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition active:scale-95 ${code ? 'hover:opacity-80' : ''}`}
                          style={{
                            backgroundColor: isAlreadySaved ? '#ef4444' : '#FACC15',
                            color: isAlreadySaved ? '#fff' : '#000',
                            opacity: code ? 1 : 0.5
                          }}
                        >
                          {isAlreadySaved ? '解除' : '登録'}
                        </button>
                      </div>
                      {/* ズームコントロール（中央） */}
                      <div className="flex items-center gap-1 rounded-lg px-1" style={{ backgroundColor: 'var(--bg-tertiary)' }}>
                        <button
                          onClick={() => setZoomLevel(z => Math.max(50, z - 10))}
                          disabled={zoomLevel <= 50}
                          className="p-1.5 hover:opacity-70 disabled:opacity-30 transition active:scale-95"
                          style={{ color: 'var(--text-secondary)' }}
                          title="縮小"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
                          </svg>
                        </button>
                        <button
                          onClick={() => setZoomLevel(100)}
                          className="px-2 py-1 text-xs hover:opacity-70 transition min-w-[3rem]"
                          style={{ color: 'var(--text-secondary)' }}
                          title="リセット"
                        >
                          {zoomLevel}%
                        </button>
                        <button
                          onClick={() => setZoomLevel(z => Math.min(150, z + 10))}
                          disabled={zoomLevel >= 150}
                          className="p-1.5 hover:opacity-70 disabled:opacity-30 transition active:scale-95"
                          style={{ color: 'var(--text-secondary)' }}
                          title="拡大"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                          </svg>
                        </button>
                      </div>
                      <div className="flex gap-1">
                        {/* 三点メニュー（コード・共有・ダウンロード・PNG・印刷）- 一番右 */}
                        <div className="relative">
                          <button
                            onClick={() => setShowPreviewMenu(!showPreviewMenu)}
                            disabled={!code}
                            className={`p-2 rounded-lg transition active:scale-95 ${code ? 'hover:opacity-80' : ''}`}
                            style={{
                              backgroundColor: 'var(--bg-tertiary)',
                              color: code ? 'var(--text-primary)' : 'var(--text-secondary)'
                            }}
                            title="その他"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                            </svg>
                          </button>
                          {/* ポップアップメニュー */}
                          {showPreviewMenu && (
                            <>
                            <div className="fixed inset-0 z-40" onClick={() => setShowPreviewMenu(false)} />
                            <div className="absolute bottom-full right-0 mb-2 rounded-lg shadow-xl p-1 z-50 flex gap-1" style={{ backgroundColor: 'var(--bg-primary)', border: '1px solid var(--border)' }}>
                              {/* コード表示 */}
                              <button
                                onClick={() => { setActiveTab('code'); setShowPreviewMenu(false); }}
                                className="p-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition active:scale-95"
                                title="コード表示"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                              </button>
                              {/* 共有 */}
                              <button
                                onClick={() => { handleShare(); setShowPreviewMenu(false); }}
                                disabled={isShortening}
                                className="p-2 rounded-lg hover:opacity-80 transition active:scale-95"
                                style={{ backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)' }}
                                title="共有"
                              >
                                {isShortening ? (
                                  <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                  </svg>
                                ) : (
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                  </svg>
                                )}
                              </button>
                              {/* ダウンロード */}
                              <button
                                onClick={() => { handleDownload(); setShowPreviewMenu(false); }}
                                className="p-2 rounded-lg bg-green-600 hover:bg-green-500 text-white transition active:scale-95"
                                title="ダウンロード"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                              </button>
                              {/* PNG（SVGモードのみ） */}
                              {currentMode === 'SVG' && (
                                <button
                                  onClick={() => { handleDownloadPng(); setShowPreviewMenu(false); }}
                                  className="p-2 rounded-lg bg-pink-600 hover:bg-pink-500 text-white transition active:scale-95"
                                  title="PNG変換"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                  </svg>
                                </button>
                              )}
                              {/* 印刷 */}
                              <button
                                onClick={() => { handlePrint(); setShowPreviewMenu(false); }}
                                className="p-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white transition active:scale-95"
                                title="印刷"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                              </button>
                            </div>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>


            {/* カスタム確認ダイアログ（ブラウザ風） */}
            {confirmDialog.show && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]">
                <div className="bg-white rounded-lg shadow-xl mx-4 max-w-sm w-full overflow-hidden">
                  <div className="px-4 py-3 text-gray-900 text-sm text-center">
                    {confirmDialog.message}
                  </div>
                  <div className="flex border-t border-gray-200">
                    <button
                      onClick={() => setConfirmDialog({ show: false, message: '', onConfirm: null })}
                      className="flex-1 py-3 text-blue-600 font-medium text-base border-r border-gray-200 active:bg-gray-100"
                    >
                      キャンセル
                    </button>
                    <button
                      onClick={confirmDialog.onConfirm}
                      className="flex-1 py-3 text-blue-600 font-medium text-base active:bg-gray-100"
                    >
                      OK
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* 同期モーダル */}
            {syncModal.show && (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[300]" onClick={closeSyncModal}>
                <div className="rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" style={{ backgroundColor: 'var(--bg-primary)' }} onClick={e => e.stopPropagation()}>
                  {syncModal.mode === 'generate' ? (
                    <>
                      <div className="p-6 text-center">
                        <h3 className="font-bold text-lg mb-2" style={{ color: 'var(--text-primary)' }}>同期コード</h3>
                        <p className="text-sm mb-4" style={{ color: 'var(--text-secondary)' }}>{syncModal.count}件のデータ</p>
                        {syncModal.loading ? (
                          <div className="py-8">
                            <div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                            <p className="text-sm mt-4" style={{ color: 'var(--text-secondary)' }}>コード発行中...</p>
                          </div>
                        ) : syncModal.error ? (
                          <div className="py-8">
                            <p className="text-red-400">{syncModal.error}</p>
                          </div>
                        ) : (
                          <>
                            <div className="rounded-lg py-6 px-4" style={{ backgroundColor: 'var(--bg-secondary)' }}>
                              <p className="text-5xl font-mono font-bold tracking-[0.3em]" style={{ color: 'var(--text-primary)' }}>{syncModal.code}</p>
                            </div>
                            <p className="text-xs mt-4" style={{ color: 'var(--text-secondary)' }}>1分間有効・1回限り</p>
                          </>
                        )}
                      </div>
                      <div style={{ borderTop: '1px solid var(--border)' }}>
                        <button
                          onClick={closeSyncModal}
                          className="w-full py-4 text-blue-400 font-medium text-base hover:opacity-80 active:opacity-60"
                        >
                          閉じる
                        </button>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="p-6 text-center">
                        <h3 className="font-bold text-lg mb-2" style={{ color: 'var(--text-primary)' }}>同期コード入力</h3>
                        <p className="text-sm mb-4" style={{ color: 'var(--text-secondary)' }}>デスクトップで表示されたコードを入力</p>
                        <input
                          type="text"
                          inputMode="numeric"
                          pattern="[0-9]*"
                          maxLength={4}
                          value={syncCodeInput}
                          onChange={(e) => setSyncCodeInput(e.target.value.replace(/\D/g, '').slice(0, 4))}
                          className="w-full text-center text-4xl font-mono font-bold tracking-[0.3em] rounded-lg py-4 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)' }}
                          placeholder="0000"
                          autoFocus
                        />
                        {syncModal.error && (
                          <p className="text-red-400 text-sm mt-3">{syncModal.error}</p>
                        )}
                      </div>
                      <div className="flex" style={{ borderTop: '1px solid var(--border)' }}>
                        <button
                          onClick={closeSyncModal}
                          className="flex-1 py-4 font-medium text-base hover:opacity-80 active:opacity-60"
                          style={{ color: 'var(--text-secondary)', borderRight: '1px solid var(--border)' }}
                        >
                          キャンセル
                        </button>
                        <button
                          onClick={fetchSyncData}
                          disabled={syncModal.loading || syncCodeInput.length !== 4}
                          className={`flex-1 py-4 font-medium text-base hover:opacity-80 active:opacity-60 ${syncModal.loading || syncCodeInput.length !== 4 ? 'opacity-50' : ''}`}
                          style={{ color: syncModal.loading || syncCodeInput.length !== 4 ? 'var(--text-secondary)' : '#60A5FA' }}
                        >
                          {syncModal.loading ? '取得中...' : '取得'}
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* タイトル編集モーダル（モバイル） */}
            {editingItem && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]" onClick={() => setEditingItem(null)}>
                <div className="rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" style={{ backgroundColor: 'var(--bg-primary)' }} onClick={e => e.stopPropagation()}>
                  <div className="p-4">
                    <h3 className="font-bold text-base mb-3" style={{ color: 'var(--text-primary)' }}>タイトル変更</h3>
                    <input
                      type="text"
                      value={editingItem.title}
                      onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          updateTitle(editingItem.id, editingItem.title);
                        } else if (e.key === 'Escape') {
                          setEditingItem(null);
                        }
                      }}
                      className="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      style={{ backgroundColor: 'var(--bg-secondary)', border: '1px solid var(--border)', color: 'var(--text-primary)' }}
                      autoFocus
                    />
                  </div>
                  <div className="flex" style={{ borderTop: '1px solid var(--border)' }}>
                    <button
                      onClick={() => setEditingItem(null)}
                      className="flex-1 py-3 font-medium text-base hover:opacity-80 active:opacity-60"
                      style={{ color: 'var(--text-secondary)', borderRight: '1px solid var(--border)' }}
                    >
                      キャンセル
                    </button>
                    <button
                      onClick={() => updateTitle(editingItem.id, editingItem.title)}
                      className="flex-1 py-3 text-blue-400 font-medium text-base hover:opacity-80 active:opacity-60"
                    >
                      保存
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* アクションメニュー（モバイル）- 上部アクション＋下部プレビュー */}
            {actionMenu && (
              <div className="fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-[200] p-4" onClick={() => setActionMenu(null)}>
                {/* 上部：アクションメニュー */}
                <div className="rounded-xl w-full max-w-sm overflow-hidden shadow-2xl mb-3" style={{ backgroundColor: 'var(--bg-primary)' }} onClick={e => e.stopPropagation()}>
                  <div className="p-3" style={{ borderBottom: '1px solid var(--border)' }}>
                    <p className="font-medium text-sm truncate" style={{ color: 'var(--text-primary)' }}>{actionMenu.title}</p>
                  </div>
                  <div className="grid grid-cols-4 gap-1 p-2">
                    <button
                      onClick={async () => {
                        try {
                          await navigator.clipboard.writeText(actionMenu.code);
                          if (navigator.vibrate) navigator.vibrate(30);
                          setActionMenu(null);
                        } catch (e) {
                          showToast('コピーに失敗しました', 3000, 'error');
                        }
                      }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg hover:opacity-80 active:opacity-60 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                      </svg>
                      <span className="text-xs" style={{ color: 'var(--text-secondary)' }}>コピー</span>
                    </button>
                    <button
                      onClick={async () => {
                        const item = {
                          id: actionMenu.id,
                          title: actionMenu.title,
                          type: actionMenu.type,
                          code: actionMenu.code,
                          createdAt: actionMenu.createdAt
                        };
                        setActionMenu(null);
                        setSyncModal({ show: true, mode: 'generate', code: null, loading: true, error: null, count: 1 });
                        try {
                          const response = await fetch(`${SYNC_URL}/sync`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify([item])
                          });
                          const result = await response.json();
                          if (result.code) {
                            setSyncModal(prev => ({ ...prev, loading: false, code: result.code }));
                          } else {
                            throw new Error(result.error || 'Unknown error');
                          }
                        } catch (err) {
                          console.error('Sync error:', err);
                          setSyncModal(prev => ({ ...prev, loading: false, error: 'コード発行に失敗しました' }));
                        }
                      }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg hover:opacity-80 active:opacity-60 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 11l5-5m0 0l5 5m-5-5v12" />
                      </svg>
                      <span className="text-xs" style={{ color: 'var(--text-secondary)' }}>送信</span>
                    </button>
                    <button
                      onClick={() => { setEditingItem({ id: actionMenu.id, title: actionMenu.title }); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg hover:opacity-80 active:opacity-60 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                      <span className="text-xs" style={{ color: 'var(--text-secondary)' }}>編集</span>
                    </button>
                    <button
                      onClick={() => { handleDelete(actionMenu.id); setActionMenu(null); }}
                      className="flex flex-col items-center gap-1 p-2 rounded-lg hover:opacity-80 active:opacity-60 transition"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <span className="text-xs" style={{ color: 'var(--text-secondary)' }}>削除</span>
                    </button>
                  </div>
                </div>
                {/* プレビュー（最大化） */}
                <div className="relative bg-white rounded-xl w-full overflow-hidden shadow-2xl flex-1" style={{ maxHeight: '70vh' }} onClick={e => e.stopPropagation()}>
                  {/* 右上×ボタン */}
                  <button
                    onClick={() => setActionMenu(null)}
                    className="absolute top-2 right-2 z-10 w-8 h-8 flex items-center justify-center rounded-full bg-black/50 text-white text-xl active:bg-black/70"
                  >
                    ×
                  </button>
                  <div className="w-full h-full overflow-auto">
                    {actionMenu.type === 'SVG' ? (
                      <div
                        className="w-full h-full flex items-center justify-center bg-gray-100 p-2"
                        dangerouslySetInnerHTML={{ __html: actionMenu.code }}
                      />
                    ) : (
                      <iframe
                        srcDoc={actionMenu.code}
                        className="w-full h-full border-0"
                        style={{ minHeight: '60vh' }}
                        sandbox="allow-scripts"
                        title="preview"
                      />
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* トースト通知（overflow-hidden外に配置） */}
          {toast.show && (
            <div
              className="fixed top-0 left-0 right-0 bottom-0 z-[250] flex items-center justify-center"
              style={{ backgroundColor: 'rgba(0,0,0,0.3)' }}
              onClick={dismissToast}
            >
              <div
                className="px-6 py-3 rounded-full shadow-lg"
                style={{
                  ...getToastStyle(toast.type),
                  textAlign: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                {renderToastMessage(toast.message, toast.type)}
              </div>
            </div>
          )}
          </>
        );
      }

      // デスクトップレイアウト（3カラム同時表示）
      return (
        <div className="flex flex-col h-screen" style={{ backgroundColor: 'var(--bg-primary)' }}>
          {/* ヘッダー */}
          {!isFullscreen && (
          <div className="px-4 py-2 flex items-center justify-between" style={{ backgroundColor: 'var(--bg-secondary)', borderBottom: '1px solid var(--border)' }}>
            <div className="flex items-center gap-3">
              <h1 className="font-bold text-base" style={{ color: 'var(--text-primary)' }}>Preview Tool</h1>
              <span
                className={`px-2 py-0.5 text-xs rounded-full font-medium ${
                  currentMode === 'SVG'
                    ? 'bg-purple-600 text-white'
                    : currentMode === 'TEXT'
                    ? 'text-white'
                    : 'bg-blue-600 text-white'
                }`}
                style={currentMode === 'TEXT' ? { backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)' } : undefined}
              >
                {currentMode}
              </span>
            </div>
            <div className="flex gap-1 items-center">
              {/* ファイル操作グループ */}
              <div className="flex items-center rounded-lg overflow-hidden" style={{ backgroundColor: 'var(--bg-tertiary)' }}>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="px-3 py-1.5 hover:bg-purple-600/20 text-sm transition flex items-center gap-1.5"
                  style={{ color: 'var(--text-primary)' }}
                  title="ファイルを開く (Ctrl+O)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                  </svg>
                  開く
                </button>
                {code && (
                  <button
                    onClick={handleClear}
                    className="px-3 py-1.5 hover:bg-red-600/20 text-sm transition flex items-center gap-1.5"
                    style={{ color: 'var(--text-primary)', borderLeft: '1px solid var(--border)' }}
                    title="クリア"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                )}
              </div>

              <div className="w-px h-5 mx-1" style={{ backgroundColor: 'var(--border)' }}></div>

              {/* アクショングループ */}
              <button
                onClick={handleSave}
                className="px-3 py-1.5 text-sm rounded-lg transition flex items-center gap-1.5 btn-press"
                style={{
                  backgroundColor: isAlreadySaved ? 'rgba(239, 68, 68, 0.15)' : 'rgba(202, 138, 4, 0.15)',
                  color: isAlreadySaved ? '#f87171' : '#fbbf24'
                }}
                title="ライブラリに登録 (Ctrl+S)"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill={isAlreadySaved ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
                {isAlreadySaved ? '解除' : '登録'}
              </button>

              {code && (
                <button
                  onClick={handleDownload}
                  className="px-3 py-1.5 text-sm rounded-lg transition flex items-center gap-1.5 btn-press"
                  style={{ backgroundColor: 'rgba(34, 197, 94, 0.15)', color: '#4ade80' }}
                  title="ダウンロード (Ctrl+Shift+D)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  DL
                </button>
              )}

              {currentMode === 'SVG' && (
                <button
                  onClick={handleDownloadPng}
                  className="px-3 py-1.5 text-sm rounded-lg transition flex items-center gap-1.5 btn-press"
                  style={{ backgroundColor: 'rgba(236, 72, 153, 0.15)', color: '#f472b6' }}
                  title="PNG変換"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  PNG
                </button>
              )}

              <button
                onClick={handlePrint}
                className="px-3 py-1.5 text-sm rounded-lg transition flex items-center gap-1.5 btn-press"
                style={{ backgroundColor: 'rgba(251, 146, 60, 0.15)', color: '#fb923c' }}
                title="印刷"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
              </button>

              <button
                onClick={handleShare}
                disabled={isShortening}
                className="px-3 py-1.5 text-sm rounded-lg transition flex items-center gap-1.5 btn-press"
                style={{ backgroundColor: isShortening ? 'rgba(96, 165, 250, 0.1)' : 'rgba(59, 130, 246, 0.15)', color: '#60a5fa' }}
                title="URL共有"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                {isShortening ? '...' : '共有'}
              </button>

              <div className="w-px h-5 mx-1" style={{ backgroundColor: 'var(--border)' }}></div>

              {/* テーマ切替 */}
              <button
                onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')}
                className="p-1.5 rounded-lg hover:opacity-70 transition"
                style={{ color: 'var(--text-secondary)' }}
                title={`${theme === 'dark' ? 'ライト' : 'ダーク'}モード (Ctrl+Shift+T)`}
              >
                {theme === 'dark' ? (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                ) : (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                  </svg>
                )}
              </button>
            </div>
          </div>
          )}

          {/* 3カラムコンテンツ */}
          <div className="flex-1 flex overflow-hidden">
            {/* 左: コードエディタ */}
            {!isFullscreen && (
            <div
              className="flex flex-col relative"
              style={{ width: `${codePanelWidth}%`, minWidth: '200px' }}
              onDragOver={handleDragOver}
              onDragLeave={handleDragLeave}
              onDrop={handleDrop}
            >
              <div className="px-4 py-2 text-sm font-medium" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)', borderBottom: '1px solid var(--border)' }}>
                コード
              </div>
              <div className="relative flex-1">
                <textarea
                  value={code}
                  onChange={(e) => setCode(e.target.value)}
                  className="w-full h-full text-green-400 font-mono text-sm p-4 resize-none focus:outline-none"
                  style={{ backgroundColor: theme === 'dark' ? '#030712' : 'var(--bg-tertiary)', color: theme === 'dark' ? '#4ade80' : '#166534' }}
                  placeholder="ここにHTMLまたはSVGコードを貼り付けてください...&#10;&#10;ファイルをドラッグ&ドロップも可能です"
                  spellCheck={false}
                />
                {/* ドラッグオーバー時のオーバーレイ */}
                {isDragOver && (
                  <div className="absolute inset-0 bg-blue-500/20 border-2 border-dashed border-blue-500 rounded flex items-center justify-center z-20">
                    <div className="text-blue-400 font-medium text-lg">ファイルをドロップ</div>
                  </div>
                )}
              </div>
              {/* リサイザー（コード↔プレビュー） */}
              <div
                className="group absolute right-0 top-0 bottom-0 w-3 cursor-col-resize z-10 flex items-center justify-center"
                onMouseDown={handleResizeStart('code')}
              >
                <div className="absolute inset-0" style={{ backgroundColor: 'var(--border)', width: '1px', left: '50%', transform: 'translateX(-50%)' }} />
                <div className="w-1 h-8 rounded-full bg-gray-500/40 group-hover:bg-blue-500 group-hover:h-16 transition-all duration-200 z-10" />
              </div>
            </div>
            )}

            {/* 中央: プレビュー */}
            <div className={`${isFullscreen ? 'w-full h-full' : ''} flex flex-col relative`} style={isFullscreen ? {} : { width: `${previewPanelWidth}%`, minWidth: '250px' }}>
              {!isFullscreen && (
              <div className="px-4 py-2 text-sm font-medium flex items-center justify-between" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)', borderBottom: '1px solid var(--border)' }}>
                <span>プレビュー</span>
                <div className="flex items-center gap-2">
                  {code && activeTab !== 'library' && (
                    <button
                      onClick={sendCurrentCode}
                      className="px-2 py-1 rounded text-xs font-medium transition hover:opacity-80 active:scale-95 btn-press"
                      style={{ backgroundColor: '#22c55e', color: '#fff' }}
                      title="同期コード発行"
                    >
                      ↑送信
                    </button>
                  )}
                  <button
                    onClick={() => setIsFullscreen(true)}
                    className="p-1 hover:opacity-70 rounded transition"
                    title="最大化"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                  </button>
                </div>
              </div>
              )}
              <div className="flex-1 overflow-hidden">
                {currentMode === 'SVG' ? (
                  <div
                    className="w-full h-full bg-gray-100 overflow-auto p-4"
                    style={{ userSelect: 'text', WebkitUserSelect: 'text' }}
                    dangerouslySetInnerHTML={{ __html: extractSvgTag(debouncedCode.trim()) }}
                  />
                ) : currentMode === 'TEXT' ? (
                  <iframe
                    srcDoc={previewCode}
                    title="Preview"
                    className="w-full h-full border-0 bg-white"
                    sandbox="allow-scripts"
                  />
                ) : (
                  <iframe
                    srcDoc={previewCode}
                    title="Preview"
                    className="w-full h-full border-0 bg-white"
                    sandbox="allow-scripts"
                  />
                )}
              </div>
              {/* フルスクリーン解除ボタン */}
              {isFullscreen && (
                <button
                  onClick={() => setIsFullscreen(false)}
                  className="absolute top-4 right-4 p-2 rounded-lg shadow-lg transition z-50 hover:opacity-80"
                  style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)' }}
                  title="元に戻す (ESC)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              )}
              {/* リサイザー（プレビュー↔ライブラリ） */}
              {!isFullscreen && (
                <div
                  className="group absolute right-0 top-0 bottom-0 w-3 cursor-col-resize z-10 flex items-center justify-center"
                  onMouseDown={handleResizeStart('preview')}
                >
                  <div className="absolute inset-0" style={{ backgroundColor: 'var(--border)', width: '1px', left: '50%', transform: 'translateX(-50%)' }} />
                  <div className="w-1 h-8 rounded-full bg-gray-500/40 group-hover:bg-blue-500 group-hover:h-16 transition-all duration-200 z-10" />
                </div>
              )}
            </div>

            {/* 右: ライブラリ */}
            {!isFullscreen && (
            <div className="flex-1 flex flex-col" style={{ minWidth: '200px' }}>
              <div className="px-4 py-2 text-sm font-medium" style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)', borderBottom: '1px solid var(--border)' }}>
                ライブラリ {savedItems.length > 0 && `(${savedItems.length})`}
              </div>
              {/* 検索バー */}
              <div className="px-3 py-2" style={{ backgroundColor: 'var(--bg-primary)', borderBottom: '1px solid var(--border)' }}>
                <div className="flex items-center gap-2">
                  <div className="relative flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2" style={{ color: 'var(--text-secondary)' }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="検索..."
                      className="w-full pl-9 pr-8 py-1.5 rounded text-sm focus:outline-none focus:ring-1 focus:ring-yellow-500"
                      style={{ backgroundColor: 'var(--bg-secondary)', border: '1px solid var(--border)', color: 'var(--text-primary)' }}
                    />
                    {searchQuery && (
                      <button
                        onClick={() => setSearchQuery('')}
                        className="absolute right-2 top-1/2 -translate-y-1/2 hover:opacity-70"
                        style={{ color: 'var(--text-secondary)' }}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                  {/* ★フィルターボタン */}
                  <button
                    onClick={() => setShowStarredOnly(!showStarredOnly)}
                    className="p-1.5 rounded border transition flex-shrink-0"
                    style={{
                      backgroundColor: showStarredOnly ? (theme === 'dark' ? 'rgba(250, 204, 21, 0.2)' : 'rgba(218, 119, 86, 0.2)') : 'var(--bg-secondary)',
                      borderColor: showStarredOnly ? 'var(--accent)' : 'var(--border)',
                      color: showStarredOnly ? 'var(--accent)' : 'var(--text-secondary)'
                    }}
                    title={showStarredOnly ? '全て表示' : '★のみ表示'}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill={showStarredOnly ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                  </button>
                </div>
              </div>
              {/* 同期ボタン */}
              <div className="px-3 py-2 flex gap-2" style={{ backgroundColor: 'var(--bg-primary)', borderBottom: '1px solid var(--border)' }}>
                <button
                  onClick={openSyncInput}
                  className="flex-1 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded transition flex items-center justify-center gap-1"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                  </svg>
                  受信
                </button>
                <button
                  onClick={generateSyncCode}
                  className="flex-1 py-1.5 bg-green-600 hover:bg-green-500 text-white text-xs rounded transition flex items-center justify-center gap-1"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                  </svg>
                  送信
                </button>
              </div>
              {/* エクスポート/インポート */}
              <div className="px-3 py-2 flex gap-2 flex-wrap" style={{ backgroundColor: 'var(--bg-primary)', borderBottom: '1px solid var(--border)' }}>
                <input
                  ref={importInputRef}
                  type="file"
                  accept=".json"
                  onChange={handleImport}
                  className="hidden"
                />
                <button
                  onClick={() => importInputRef.current?.click()}
                  className="py-1 px-3 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded transition"
                >
                  インポート
                </button>
                <button
                  onClick={toggleSelectAll}
                  disabled={savedItems.length === 0}
                  className={`py-1 px-3 text-white text-xs rounded transition ${savedItems.length === 0 ? 'opacity-50' : 'bg-slate-600 hover:bg-slate-500'}`}
                  style={savedItems.length === 0 ? { backgroundColor: 'var(--bg-tertiary)' } : {}}
                >
                  {allFilteredSelected ? '全解除' : '全選択'}
                </button>
                <button
                  onClick={handleExport}
                  disabled={selectedItems.size === 0}
                  className={`py-1 px-3 text-white text-xs rounded transition ${selectedItems.size === 0 ? 'opacity-50' : 'bg-green-600 hover:bg-green-500'}`}
                  style={selectedItems.size === 0 ? { backgroundColor: 'var(--bg-tertiary)' } : {}}
                >
                  {selectedItems.size > 0 ? `保存(${selectedItems.size})` : '保存'}
                </button>
              </div>
              {/* アイテムリスト */}
              <div className="flex-1 overflow-auto p-2" style={{ backgroundColor: theme === 'dark' ? '#030712' : 'var(--bg-tertiary)' }}>
                {savedItems.length === 0 ? (
                  <div className="text-center py-8 text-sm" style={{ color: 'var(--text-secondary)' }}>
                    <p>まだ登録がありません</p>
                  </div>
                ) : (() => {
                  const filteredItems = savedItems.filter(item => {
                    if (showStarredOnly && !item.starred) return false;
                    if (!searchQuery.trim()) return true;
                    const query = searchQuery.toLowerCase();
                    return item.title.toLowerCase().includes(query) ||
                           item.code.toLowerCase().includes(query) ||
                           item.type.toLowerCase().includes(query);
                  });
                  return filteredItems.length === 0 ? (
                    <div className="text-center py-8 text-sm" style={{ color: 'var(--text-secondary)' }}>
                      <p>{showStarredOnly ? '★付きの項目なし' : `「${searchQuery}」に一致する項目なし`}</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {filteredItems.map(item => (
                        <div
                          key={item.id}
                          className={`rounded-lg p-3 cursor-pointer transition-all duration-200 ${selectedItems.has(item.id) ? 'ring-2 ring-blue-500 item-selected' : ''}`}
                          style={{
                            backgroundColor: 'var(--bg-secondary)'
                          }}
                          onContextMenu={(e) => {
                            if (!isMobile) {
                              e.preventDefault();
                              setContextMenuPos({ x: e.clientX, y: e.clientY });
                              setActionMenu(item);
                            }
                          }}
                        >
                          <div className="flex items-start gap-2">
                            <div
                              className={`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 cursor-pointer mt-0.5 ${selectedItems.has(item.id) ? 'bg-blue-500 border-blue-500' : ''}`}
                              style={!selectedItems.has(item.id) ? { borderColor: 'var(--text-secondary)' } : undefined}
                              onClick={(e) => { e.stopPropagation(); toggleSelectItem(item.id); }}
                            >
                              {selectedItems.has(item.id) && (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                </svg>
                              )}
                            </div>
                            <div className="flex-1 min-w-0" onClick={() => handleLoad(item)}>
                              <div className="flex items-center gap-2 mb-1">
                                {item.starred && (
                                  <span className="text-yellow-400 flex-shrink-0 text-sm">★</span>
                                )}
                                <span
                                  className="font-medium truncate"
                                  style={{ color: 'var(--text-primary)' }}
                                >
                                  {item.title}
                                </span>
                              </div>
                              <div className="flex items-center gap-2 text-xs" style={{ color: 'var(--text-secondary)' }}>
                                <span
                                  className="px-1.5 py-0.5 rounded text-xs font-medium"
                                  style={{
                                    backgroundColor: item.type === 'svg' ? 'rgba(168, 85, 247, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                    color: item.type === 'svg' ? '#a855f7' : '#3b82f6'
                                  }}
                                >
                                  {item.type?.toUpperCase() || 'HTML'}
                                </span>
                                {item.updatedAt && (
                                  <span>{new Date(item.updatedAt).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                )}
                              </div>
                            </div>
                            <button
                              onClick={(e) => { e.stopPropagation(); setActionMenu(item); }}
                              className="p-1.5 hover:bg-white/10 rounded transition flex-shrink-0"
                              style={{ color: 'var(--text-secondary)' }}
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="5" r="2"/>
                                <circle cx="12" cy="12" r="2"/>
                                <circle cx="12" cy="19" r="2"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
            )}
          </div>

          {/* カスタム確認ダイアログ */}
          {confirmDialog.show && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]">
              <div className="bg-white rounded-lg shadow-xl mx-4 max-w-sm w-full overflow-hidden">
                <div className="px-4 py-3 text-gray-900 text-sm text-center">
                  {confirmDialog.message}
                </div>
                <div className="flex border-t border-gray-200">
                  <button
                    onClick={() => setConfirmDialog({ show: false, message: '', onConfirm: null })}
                    className="flex-1 py-3 text-blue-600 font-medium text-base border-r border-gray-200 active:bg-gray-100"
                  >
                    キャンセル
                  </button>
                  <button
                    onClick={confirmDialog.onConfirm}
                    className="flex-1 py-3 text-blue-600 font-medium text-base active:bg-gray-100"
                  >
                    OK
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* トースト通知 */}
          {toast.show && (
            <div
              className="fixed inset-0 z-[250] flex items-center justify-center"
              style={{ backgroundColor: 'rgba(0,0,0,0.3)' }}
              onClick={dismissToast}
            >
              <div
                className="px-6 py-3 rounded-full shadow-lg"
                style={{
                  ...getToastStyle(toast.type),
                  textAlign: 'center'
                }}
                onClick={(e) => e.stopPropagation()}
              >
                {renderToastMessage(toast.message, toast.type)}
              </div>
            </div>
          )}

          {/* タイトル編集モーダル */}
          {editingItem && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[200]" onClick={() => setEditingItem(null)}>
              <div className="rounded-xl mx-4 max-w-sm w-full overflow-hidden shadow-2xl" style={{ backgroundColor: 'var(--bg-primary)' }} onClick={e => e.stopPropagation()}>
                <div className="p-4">
                  <h3 className="font-bold text-base mb-3" style={{ color: 'var(--text-primary)' }}>タイトル変更</h3>
                  <input
                    type="text"
                    value={editingItem.title}
                    onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        updateTitle(editingItem.id, editingItem.title);
                      } else if (e.key === 'Escape') {
                        setEditingItem(null);
                      }
                    }}
                    className="w-full px-3 py-2 rounded-lg focus:outline-none focus:border-blue-500"
                    style={{ backgroundColor: 'var(--bg-secondary)', border: '1px solid var(--border)', color: 'var(--text-primary)' }}
                    autoFocus
                  />
                </div>
                <div className="flex" style={{ borderTop: '1px solid var(--border)' }}>
                  <button
                    onClick={() => setEditingItem(null)}
                    className="flex-1 py-3 font-medium text-base active:opacity-70"
                    style={{ color: 'var(--text-secondary)', borderRight: '1px solid var(--border)' }}
                  >
                    キャンセル
                  </button>
                  <button
                    onClick={() => updateTitle(editingItem.id, editingItem.title)}
                    className="flex-1 py-3 text-blue-400 font-medium text-base active:opacity-70"
                  >
                    保存
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* アクションメニュー */}
          {actionMenu && (
            <div
              className="fixed inset-0 z-[200]"
              style={{ backgroundColor: contextMenuPos ? 'transparent' : 'rgba(0,0,0,0.6)' }}
              onClick={() => { setActionMenu(null); setContextMenuPos(null); }}
            >
              <div
                className={contextMenuPos ? 'fixed rounded-lg overflow-hidden shadow-2xl' : 'fixed bottom-0 left-0 right-0 sm:bottom-auto sm:left-1/2 sm:top-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 rounded-t-2xl sm:rounded-xl w-full sm:max-w-xs overflow-hidden shadow-2xl'}
                style={{
                  backgroundColor: 'var(--bg-primary)',
                  ...(contextMenuPos ? {
                    left: Math.min(contextMenuPos.x, window.innerWidth - 200),
                    top: Math.min(contextMenuPos.y, window.innerHeight - 300),
                    width: '200px'
                  } : {})
                }}
                onClick={e => e.stopPropagation()}
              >
                <div className="p-3" style={{ borderBottom: '1px solid var(--border)' }}>
                  <p className="font-medium text-sm truncate" style={{ color: 'var(--text-primary)' }}>{actionMenu.title}</p>
                </div>
                <div className="py-1">
                  <button
                    onClick={() => { handleLoad(actionMenu); setActionMenu(null); setContextMenuPos(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:opacity-80 active:opacity-70 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span style={{ color: 'var(--text-primary)' }}>読み込み</span>
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        await navigator.clipboard.writeText(actionMenu.code);
                        if (navigator.vibrate) navigator.vibrate(30);
                        setActionMenu(null);
                        setContextMenuPos(null);
                      } catch (e) {
                        showToast('コピーに失敗しました', 3000, 'error');
                      }
                    }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:opacity-80 active:opacity-70 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    <span style={{ color: 'var(--text-primary)' }}>コードをコピー</span>
                  </button>
                  <button
                    onClick={() => { toggleStar(actionMenu.id); setActionMenu(null); setContextMenuPos(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:opacity-80 active:opacity-70 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ${actionMenu.starred ? 'text-yellow-400' : ''}`} style={!actionMenu.starred ? { color: 'var(--text-secondary)' } : undefined} fill={actionMenu.starred ? 'currentColor' : 'none'} viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    <span style={{ color: 'var(--text-primary)' }}>{actionMenu.starred ? '★を外す' : '★をつける'}</span>
                  </button>
                  <button
                    onClick={() => { setEditingItem({ id: actionMenu.id, title: actionMenu.title }); setActionMenu(null); setContextMenuPos(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:opacity-80 active:opacity-70 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span style={{ color: 'var(--text-primary)' }}>タイトル編集</span>
                  </button>
                  <button
                    onClick={() => { handleDelete(actionMenu.id); setActionMenu(null); setContextMenuPos(null); }}
                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:opacity-80 active:opacity-70 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span style={{ color: 'var(--text-primary)' }}>削除</span>
                  </button>
                </div>
                {!contextMenuPos && (
                <div className="p-2" style={{ borderTop: '1px solid var(--border)' }}>
                  <button
                    onClick={() => setActionMenu(null)}
                    className="w-full py-2 font-medium text-sm active:opacity-70 rounded-lg"
                    style={{ color: 'var(--text-secondary)' }}
                  >
                    キャンセル
                  </button>
                </div>
                )}
              </div>
            </div>
          )}

          {/* 同期モーダル */}
          {syncModal.show && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[300]" onClick={closeSyncModal}>
              <div className="rounded-xl mx-4 max-w-md w-full overflow-hidden shadow-2xl" style={{ backgroundColor: 'var(--bg-primary)' }} onClick={e => e.stopPropagation()}>
                {syncModal.mode === 'generate' ? (
                  <>
                    <div className="p-6 text-center">
                      <h3 className="font-bold text-lg mb-2" style={{ color: 'var(--text-primary)' }}>同期コード</h3>
                      <p className="text-sm mb-4" style={{ color: 'var(--text-secondary)' }}>{syncModal.count}件のデータ</p>
                      {syncModal.loading ? (
                        <div className="py-8">
                          <div className="animate-spin w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                          <p className="text-sm mt-4" style={{ color: 'var(--text-secondary)' }}>コード発行中...</p>
                        </div>
                      ) : syncModal.error ? (
                        <div className="py-8">
                          <p className="text-red-400">{syncModal.error}</p>
                        </div>
                      ) : (
                        <>
                          <div className="rounded-lg py-8 px-6" style={{ backgroundColor: 'var(--bg-secondary)' }}>
                            <p className="text-6xl font-mono font-bold tracking-[0.4em]" style={{ color: 'var(--text-primary)' }}>{syncModal.code}</p>
                          </div>
                          <button
                            onClick={async () => {
                              try {
                                await navigator.clipboard.writeText(syncModal.code);
                                showToast('コードをコピーしました', 2000, 'success');
                              } catch (e) {
                                showToast('コピーに失敗しました', 3000, 'error');
                              }
                            }}
                            className="mt-4 px-4 py-2 rounded-lg text-sm font-medium hover:opacity-80 active:opacity-60 transition"
                            style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)' }}
                          >
                            コードをコピー
                          </button>
                          <p className="text-xs mt-4" style={{ color: 'var(--text-secondary)' }}>1分間有効・1回限り</p>
                        </>
                      )}
                    </div>
                    <div style={{ borderTop: '1px solid var(--border)' }}>
                      <button
                        onClick={closeSyncModal}
                        className="w-full py-4 text-blue-400 font-medium text-base active:opacity-70"
                      >
                        閉じる
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="p-6 text-center">
                      <h3 className="font-bold text-lg mb-2" style={{ color: 'var(--text-primary)' }}>同期コード入力</h3>
                      <p className="text-sm mb-4" style={{ color: 'var(--text-secondary)' }}>デスクトップで表示されたコードを入力</p>
                      <input
                        type="text"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        maxLength={4}
                        value={syncCodeInput}
                        onChange={(e) => setSyncCodeInput(e.target.value.replace(/\D/g, '').slice(0, 4))}
                        className="w-full text-center text-4xl font-mono font-bold tracking-[0.3em] rounded-lg py-4 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        style={{ backgroundColor: 'var(--bg-secondary)', color: 'var(--text-primary)' }}
                        placeholder="0000"
                        autoFocus
                      />
                      {syncModal.error && (
                        <p className="text-red-400 text-sm mt-3">{syncModal.error}</p>
                      )}
                    </div>
                    <div className="flex" style={{ borderTop: '1px solid var(--border)' }}>
                      <button
                        onClick={closeSyncModal}
                        className="flex-1 py-4 font-medium text-base active:opacity-70"
                        style={{ color: 'var(--text-secondary)', borderRight: '1px solid var(--border)' }}
                      >
                        キャンセル
                      </button>
                      <button
                        onClick={fetchSyncData}
                        disabled={syncModal.loading || syncCodeInput.length !== 4}
                        className={`flex-1 py-4 font-medium text-base active:opacity-70 ${syncModal.loading || syncCodeInput.length !== 4 ? 'opacity-40' : 'text-blue-400'}`}
                      >
                        {syncModal.loading ? '取得中...' : '取得'}
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<HTMLPreviewer />);
  </script>
  <script>
    // Service Worker登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
